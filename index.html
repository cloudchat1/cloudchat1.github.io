<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Google</title>

    <!-- Favicon -->
    <link id="favicon" rel="icon" href="https://www.google.com/favicon.ico">

    <!-- Tailwind (keeps your utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <style>
        :root{
            --dark-900: #0a0a0a;
            --dark-800: #1a1a1a;
            --dark-700: #2a2a2a;
            --dark-600: #3a3a3a;
            --dark-500: #4a4a4a;

            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --blue-700: #1d4ed8;

            --green-600: #16a34a;
            --green-700: #15803d;

            --red-600: #dc2626;
            --red-700: #b91c1c;

            --muted: #9ca3af;
            --glass: rgba(255,255,255,0.03);

            --radius-lg: 12px;
            --shadow-xl: 0 10px 30px rgba(0,0,0,0.6);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Chakra Petch', monospace;
            background: var(--dark-900);
            color: #e5e7eb;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        .bg-dark-800 { background: var(--dark-800) !important; }
        .bg-dark-700 { background: var(--dark-700) !important; }
        .bg-dark-900 { background: var(--dark-900) !important; }

        .auth-card, .bg-dark-800 {
            border-radius: var(--radius-lg);
            border: 1px solid var(--dark-600);
            box-shadow: var(--shadow-xl);
        }

        input[type="text"], input[type="password"], select, textarea {
            background: var(--dark-700);
            border: 1px solid var(--dark-500);
            color: #fff;
            border-radius: 10px;
            transition: box-shadow .15s ease, transform .12s ease;
        }

        input::placeholder, textarea::placeholder { color: #9ca3af; }

        input:focus, select:focus, button:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 10px;
            transition: transform .12s ease, background-color .12s ease, opacity .12s ease;
        }
        button:active { transform: translateY(1px); }
        button[disabled] { opacity: 0.5; cursor: not-allowed; }

        .fade-in { animation: fadeIn .45s ease-in-out both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .message-appear { animation: messageAppear .28s ease-out both; }
        @keyframes messageAppear { from { opacity: 0; transform: translateX(-18px) scale(.975); } to { opacity: 1; transform: translateX(0) scale(1); } }

        #messages-container { -webkit-overflow-scrolling: touch; }
        #messages-container::-webkit-scrollbar { width: 8px; height: 8px; }
        #messages-container::-webkit-scrollbar-track { background: var(--dark-800); }
        #messages-container::-webkit-scrollbar-thumb { background: var(--dark-500); border-radius: 6px; border: 1px solid rgba(255,255,255,0.02); }
        #messages-container::-webkit-scrollbar-thumb:hover { background: #6a6a6a; }

        .hidden { display: none !important; }

        .owner-shield {
            display: inline-flex; align-items: center; justify-content: center;
            width: 18px; height: 18px; border-radius: 4px; background: var(--dark-800); color: #fff; font-size: 12px; font-weight: 600; margin-left: 6px;
        }

        .dm-badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; background: rgba(255,255,255,0.03); color: #cbd5e1; border: 1px solid rgba(255,255,255,0.03); margin-left: 6px; }

        #auth-error { display: block; font-weight: 600; }

        .message-item { padding: 8px 6px; border-radius: 10px; transition: background-color .12s ease; }
        .message-item:hover { background: rgba(255,255,255,0.015); }

        @media (max-width: 640px) {
            .message-item { padding: 10px; border-radius: 8px; }
        }

        .text-red-400 { color: #fca5a5 !important; }
        .text-yellow-400 { color: #facc15 !important; }
        .text-gray-400 { color: #9ca3af !important; }

        .bg-blue-600 { background: var(--blue-600) !important; }
        .bg-blue-700 { background: var(--blue-700) !important; }
        .bg-green-600 { background: var(--green-600) !important; }
        .bg-green-700 { background: var(--green-700) !important; }
        .bg-red-600 { background: var(--red-600) !important; }
        .bg-red-700 { background: var(--red-700) !important; }

        #pin-modal {
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(180deg, rgba(10,10,10,0.5), rgba(10,10,10,0.35));
            backdrop-filter: blur(6px);
            padding: 20px;
        }
        #pin-modal > div {
            background: #0a0a0a;
            border: 1px solid rgba(255,255,255,0.03);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            border-radius: 18px;
        }

        #lock-overlay { display: none; }
        #lock-overlay:not(.hidden) { display: block; position: fixed; inset: 0; z-index: 9999; }

        #lock-overlay > .absolute { position: absolute; inset: 0; background: rgba(0, 0, 0, 0.818); backdrop-filter: blur(50px); }

        #lock-overlay .relative > .w-full {
            background: linear-gradient(180deg, var(--dark-800), var(--dark-700));
            border: 1px solid rgba(255,255,255,0.03);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }

        #pin-boxes {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 12px 0;
        }

        .pin-box {
            width: 4rem;
            height: 4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            color: #fff;
            background: #181818;
            border: 1px solid var(--dark-600);
            border-radius: 12px;
            transition: transform .12s ease, background-color .12s ease, box-shadow .12s ease;
            user-select: none;
            -webkit-user-select: none;
        }

        @media (min-width: 768px) {
            .pin-box { width: 5rem; height: 5rem; font-size: 2rem; border-radius: 14px; }
        }

        .pin-box.filled {
            background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            box-shadow: 0 4px 18px rgba(0,0,0,0.5) inset;
            transform: translateY(-2px);
        }

        @keyframes shakeX {
            0% { transform: translateX(0); }
            20% { transform: translateX(-8px); }
            40% { transform: translateX(8px); }
            60% { transform: translateX(-6px); }
            80% { transform: translateX(6px); }
            100% { transform: translateX(0); }
        }
        #pin-boxes.shake { animation: shakeX .42s ease; }

        #pin-hidden { position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0; }

        #unlock-msg { color: var(--muted); margin-top: 8px; min-height: 1em; }

        @media (max-width: 420px) {
            #pin-boxes { gap: 8px; }
            .pin-box { width: 3.2rem; height: 3.2rem; font-size: 1.2rem; }
        }

        .pin-box:focus { outline: 2px solid rgba(99,102,241,0.12); outline-offset: 3px; }

        #lock-overlay .relative { display: flex; align-items: center; justify-content: center; min-height: 100vh; }

        #pin-setup-input, #pin-setup-confirm, #pin-dummy-input, #pin-dummy-confirm {
            letter-spacing: 6px;
        }

        #pin-modal button { border-radius: 10px; }

        #pin-setup-msg, #unlock-msg { color: #9ca3af; }

        .pin-box { cursor: text; }

        .notes-app .notes-sidebar { min-width: 220px; }
        .note-item { transition: background .12s ease; }
        .note-item:hover { background: rgba(255,255,255,0.02); }
        .notes-app input, .notes-app textarea, .notes-app button { font-family: inherit; color: #e6e6e6; }
        .notes-app .notes-sidebar .note-item.bg-dark-900 { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.02); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'chakra': ['Chakra Petch', 'monospace']
                    },
                    colors: {
                        'dark': {
                            '900': '#0a0a0a',
                            '800': '#1a1a1a',
                            '700': '#2a2a2a',
                            '600': '#3a3a3a',
                            '500': '#4a4a4a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-100 font-chakra min-h-screen">

    <!-- AUTH (unchanged markup) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full">
            <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 shadow-xl">
                <div class="mb-6">
                    <div class="flex bg-dark-700 rounded-lg p-1">
                        <button id="login-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all text-white bg-blue-600">Login</button>
                        <button id="register-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all text-gray-300 hover:text-white">Register</button>
                    </div>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="login-username" placeholder="Username" required class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg">Login</button>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <input type="text" id="register-username" placeholder="Username (min 3 chars)" required minlength="3" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="Password (min 6 chars)" required minlength="6" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg">Create Account</button>
                </form>

                <div id="guest-section" class="mt-6 pt-6 border-t border-dark-600">
                    <button id="guest-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg">Sign in as Guest</button>
                </div>

                <div id="auth-error" class="mt-4 p-3 bg-red-600 text-white rounded-lg hidden"></div>
            </div>
        </div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen" class="min-h-screen flex flex-col hidden" aria-live="polite">
        <div class="bg-dark-800 border-b border-dark-600 px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <span id="user-display" class="text-gray-300"></span>
                <div>
                    <select id="user-select" class="bg-dark-700 border border-dark-500 text-gray-200 rounded px-3 py-1">
                        <option value="">All (global)</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center space-x-3">
                <button id="clear-recipient-btn" class="text-xs text-gray-400 hover:text-white hidden">Clear DM</button>

                <div class="flex items-center space-x-2">
                    <button id="pin-btn" title="Set / Change PIN" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fa-solid fa-keyboard mr-2"></i>PIN</button>
                    <button id="lock-now-btn" title="Lock now" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fas fa-lock mr-1"></i>Lock</button>
                </div>

                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">Logout</button>
            </div>
        </div>

        <div class="flex-1 flex flex-col">
            <div id="messages-container" class="flex-1 overflow-y-auto bg-dark-900 p-4 space-y-3">
                <div id="empty-state" class="text-center text-gray-400 py-8">
                    <div class="text-4xl mb-4">💬</div>
                    <p>No messages yet. Be the first to say hello!</p>
                </div>
            </div>

            <div class="bg-dark-800 border-t border-dark-600 p-4">
                <form id="message-form" class="flex space-x-3">
                    <div class="flex-1">
                        <input type="text" id="message-input" placeholder="Type your message..." maxlength="500" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none" autocomplete="off">
                    </div>
                    <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                        <span id="send-text">Send</span>
                        <span id="send-loading" class="hidden"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg></span>
                    </button>
                </form>
                <div class="mt-2 text-right">
                    <span id="char-count" class="text-xs text-gray-400">0/500</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN SETUP MODAL (centered in screen, neutral colors) -->
    <div id="pin-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
            <div class="flex items-start justify-between">
                <div>
                    <h3 id="pin-modal-title" class="text-lg font-semibold text-white">Set / Change PIN</h3>
                    <p class="text-sm text-gray-400 mt-1">Set a four digit pin and an optional dummy pin. Dummy pin will open a notes app when entered.</p>
                </div>
                <button id="pin-modal-close" class="text-gray-400 hover:text-white" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>

            <form id="pin-setup-form" class="mt-5 space-y-4" onsubmit="return false;">
                <div class="grid grid-cols-1 gap-2">
                    <label class="text-xs text-gray-300">PIN (numbers only)</label>
                    <input id="pin-setup-input" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="1234.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                    <input id="pin-setup-confirm" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="1234.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">

                    <label class="text-xs text-gray-300 mt-2">Optional — Dummy PIN (4–8 digits)</label>
                    <input id="pin-dummy-input" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="5678.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                    <input id="pin-dummy-confirm" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="5678.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                </div>

                <div class="flex items-center justify-between mt-2">
                    <div class="flex gap-2">
                        <button id="save-pin-btn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save PIN</button>
                        <button id="remove-pin-btn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Remove PIN</button>
                    </div>
                    <div id="pin-setup-msg" class="text-sm text-gray-400"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- FULLSCREEN LOCK OVERLAY (new: full-screen, big boxes, blocking) -->
    <div id="lock-overlay" class="fixed inset-0 z-60 hidden">
        <!-- Full-screen dim + blur -->
        <div class="absolute inset-0 bg-black/75 backdrop-blur-sm pointer-events-auto"></div>

        <!-- Centered lock panel (big, minimal) -->
        <div class="relative z-10 min-h-screen flex items-center justify-center p-6">
            <div id="lock-panel" class="w-full max-w-2xl mx-auto p-8 rounded-3xl border border-dark-600 bg-[#0f0f0f] shadow-2xl text-center">
                <div class="flex items-center justify-center mb-6">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl">
                        <i class="fas fa-lock"></i>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mb-2">This site is locked</h2>
                <p class="text-sm text-gray-400 mb-6">Enter your PIN to continue</p>

                <!-- PIN boxes container -->
                <div id="pin-boxes" class="flex justify-center gap-4 mb-4"></div>

                <!-- hidden fallback input for paste/focus on mobile keyboards -->
                <input id="pin-hidden" type="text" inputmode="numeric" pattern="\d*" maxlength="32" class="absolute left-[-9999px]">

                <div class="flex items-center justify-center gap-3">
                    <button id="unlock-btn" class="px-6 py-3 rounded bg-blue-600 hover:bg-blue-700 text-white">Unlock</button>
                </div>

                <div id="unlock-msg" class="mt-4 text-sm text-gray-400"></div>
            </div>
        </div>
    </div>

    <script>

        const API_BASE_URL = 'https://chat.nighthawk.work/api';
        const DEFAULT_FAVICON = 'https://www.google.com/favicon.ico';
        const NOTIF_FAVICON = 'https://cdn-icons-png.flaticon.com/512/1827/1827504.png';

        let currentUser = null;
        let lastMessageId = 0;
        let pollInterval = null;
        let config = { guest_login_enabled: true };
        let usersList = [];
        let currentRecipient = null;
        let unseenCount = 0;

        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const guestSection = document.getElementById('guest-section');
        const guestBtn = document.getElementById('guest-btn');
        const authError = document.getElementById('auth-error');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const sendLoading = document.getElementById('send-loading');
        const charCount = document.getElementById('char-count');
        const emptyState = document.getElementById('empty-state');
        const userSelect = document.getElementById('user-select');
        const clearRecipientBtn = document.getElementById('clear-recipient-btn');
        const faviconEl = document.getElementById('favicon');

        function showError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
            setTimeout(() => authError.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
        }

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function updateCharCount() {
            const len = messageInput.value.length;
            charCount.textContent = `${len}/500`;
            if (len > 450) charCount.className = 'text-xs text-red-400';
            else if (len > 400) charCount.className = 'text-xs text-yellow-400';
            else charCount.className = 'text-xs text-gray-400';
        }

        function setLoading(loading) {
            sendButton.disabled = loading;
            messageInput.disabled = loading;
            if (loading) { sendText.classList.add('hidden'); sendLoading.classList.remove('hidden'); }
            else { sendText.classList.remove('hidden'); sendLoading.classList.add('hidden'); }
        }

        function scrollToBottom() { window.scrollTo(0, document.body.scrollHeight); }

        function setFavicon(url) {
            if (faviconEl) faviconEl.href = url;
            else {
                const link = document.createElement('link'); link.id = 'favicon'; link.rel = 'icon'; link.href = url; document.head.appendChild(link);
            }
        }

        function markAsSeen() {
            unseenCount = 0; setFavicon(DEFAULT_FAVICON); document.title = 'Google';
        }
        function incrementUnread() { unseenCount += 1; setFavicon(NOTIF_FAVICON); document.title = `(${unseenCount}) Google`; }

        async function apiRequest(endpoint, options = {}) {

            try {

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Request failed');
                return data;
            } catch (err) {
                console.warn('API request failed (stubbed):', err);

                if (endpoint.startsWith('/config')) return { guest_login_enabled: true };
                if (endpoint.startsWith('/auth/login') || endpoint.startsWith('/auth/register') || endpoint.startsWith('/auth/guest')) {
                    return { user: { id: Date.now(), username: 'guest-' + Math.floor(Math.random()*9999), is_guest: true } };
                }
                if (endpoint.startsWith('/messages')) return { messages: [] };
                if (endpoint.startsWith('/users')) return { users: [] };
                return {};
            }
        }

        async function loadConfig() {
            try {
                const data = await apiRequest('/config');
                config = data;
                if (!config.guest_login_enabled) guestSection.classList.add('hidden');
            } catch (err) { console.error('Failed to load config:', err); }
        }
        async function login(username, password) {
            const data = await apiRequest('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
            return data.user;
        }
        async function register(username, password) {
            const data = await apiRequest('/auth/register', { method: 'POST', body: JSON.stringify({ username, password }) });
            return data.user;
        }
        async function guestLogin() {
            const data = await apiRequest('/auth/guest', { method: 'POST' });
            return data.user;
        }
        async function sendMessage(content, recipient_id = null) {
            const data = await apiRequest('/messages', { method: 'POST', body: JSON.stringify({ content, user_id: currentUser.id, is_guest: currentUser.is_guest || false, recipient_id }) });
            return data.message || { id: Date.now(), display_name: currentUser ? currentUser.username : 'you', username: currentUser ? currentUser.username : 'you', is_guest: currentUser ? currentUser.is_guest : true, content, timestamp: Date.now() };
        }
        async function fetchMessages() {
            const data = await apiRequest(`/messages?last_id=${lastMessageId}`);
            return data.messages || [];
        }
        async function fetchRecentMessages() { const data = await apiRequest('/messages/recent'); return data.messages || []; }
        async function loadUsers() {
            try { const data = await apiRequest('/users'); usersList = data.users || []; populateUserSelect(); } catch (err) { console.error('Failed to load users:', err); }
        }
        async function deleteMessageRequest(messageId) {
            try {
                const body = { requesting_user_id: currentUser && currentUser.id, requesting_username: currentUser && currentUser.username };
                const res = await apiRequest(`/messages/${messageId}`, { method: 'DELETE', body: JSON.stringify(body) });
                return res;
            } catch (err) { console.error('Delete message failed:', err); throw err; }
        }

        function createMessageElement(message) {
            const d = document.createElement('div');
            d.className = 'message-item fade-in';
            d.dataset.messageId = message.id;
            const isGuest = message.is_guest;
            const avatarChar = isGuest ? 'G' : (message.username && message.username[0] ? message.username[0].toUpperCase() : 'U');
            const avatarColor = isGuest ? 'from-gray-500 to-gray-600' : 'from-blue-500 to-purple-600';
            const ownerBadge = (message.username && message.username.toLowerCase() === 'owner') ? `<i class="fas fa-shield-alt text-white ml-1" title="owner"></i>` : '';
            const dmLabel = (message.recipient_id != null) ? `<span class="dm-badge">DM ${message.recipient_username ? '→ [' + escapeHtml(message.recipient_username) + ']' : ''}</span>` : '';
            let deleteButtonHtml = '';
            if (currentUser && !currentUser.is_guest && currentUser.username && currentUser.username.toLowerCase() === 'owner') {
                deleteButtonHtml = `<button data-delete-id="${message.id}" class="ml-3 text-xs px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-white flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
            }
            d.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-r ${avatarColor} flex items-center justify-center text-white text-sm font-medium">${escapeHtml(avatarChar)}</div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-medium text-white">${escapeHtml(message.display_name)}</span>
                            ${ownerBadge}
                            <span class="ml-2">${dmLabel}</span>
                            ${deleteButtonHtml}
                            <span class="text-xs text-gray-400">${formatTime(message.timestamp)}</span>
                        </div>
                        <div class="text-gray-300 break-words">${escapeHtml(message.content)}</div>
                    </div>
                </div>
            `;
            const btn = d.querySelector('button[data-delete-id]');
            if (btn) btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const id = parseInt(btn.getAttribute('data-delete-id'), 10);
                if (!confirm('Delete this message?')) return;
                try { await deleteMessageRequest(id); removeMessageElement(id); } catch (err) { showError('Failed to delete message'); }
            });
            return d;
        }

        function removeMessageElement(messageId) { const el = document.querySelector(`[data-message-id="${messageId}"]`); if (el && el.parentNode) el.parentNode.removeChild(el); }

        function messageMatchesCurrentView(message) {
            if (!currentRecipient) {
                if (message.recipient_id == null) return true;
                if (!currentUser) return false;
                return (message.user_id === currentUser.id) || (message.recipient_id === currentUser.id);
            } else {
                if (!currentUser) return false;
                const a = currentUser.id, b = currentRecipient.id;
                return (message.user_id === a && message.recipient_id === b) || (message.user_id === b && message.recipient_id === a);
            }
        }

        function clearMessages() { messagesContainer.innerHTML = ''; }
        function renderMessages(allMessages) {
            clearMessages();
            if (!allMessages || allMessages.length === 0) { emptyState.classList.remove('hidden'); return; }
            let anyShown = false;
            allMessages.forEach(message => { if (messageMatchesCurrentView(message)) { addMessage(message, false); anyShown = true; } });
            if (!anyShown) emptyState.classList.remove('hidden'); else emptyState.classList.add('hidden');
            scrollToBottom();
        }
        function addMessage(message, scroll = true) {
            if (document.querySelector(`[data-message-id="${message.id}"]`)) return;
            if (!messageMatchesCurrentView(message)) {
                if (document.hidden && currentUser) {
                    const relevant = (!message.recipient_id) || (message.recipient_id === currentUser.id) || (message.user_id === currentUser.id);
                    if (relevant) incrementUnread();
                }
                return;
            }
            emptyState.classList.add('hidden');
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
            setTimeout(() => messageElement.classList.add('message-appear'), 10);
            lastMessageId = Math.max(lastMessageId, message.id);
            if (scroll) scrollToBottom();
        }

        function loadMessages() {
            fetchRecentMessages()
                .then(messages => { if (!messages || messages.length === 0) emptyState.classList.remove('hidden'); else renderMessages(messages); })
                .catch(err => console.error('Failed to load messages:', err));
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => {
                fetchMessages().then(messages => { messages.forEach(m => addMessage(m)); loadUsers(); }).catch(err => console.error('Polling error:', err));
            }, 1000);
        }
        function stopPolling() { if (pollInterval) { clearInterval(pollInterval); pollInterval = null; } }

        function showAuthScreen() { authScreen.classList.remove('hidden'); chatScreen.classList.add('hidden'); currentUser = null; stopPolling(); markAsSeen(); }
        function showChatScreen(user) {
            currentUser = user;
            authScreen.classList.add('hidden'); chatScreen.classList.remove('hidden');
            if (user.is_guest) userDisplay.innerHTML = '[guest]';
            else {
                if (user.username && user.username.toLowerCase() === 'owner') userDisplay.innerHTML = `[${escapeHtml(user.username)}] <span class="owner-shield">★</span>`;
                else userDisplay.textContent = `[${user.username}]`;
            }
            loadUsers(); loadMessages(); startPolling(); messageInput.focus(); markAsSeen();
            if (window.PinSystem && !PinSystem.isUnlocked()) {
                PinSystem.showOverlayIfLocked();
            }
        }

        loginTab.addEventListener('click', () => { loginTab.classList.add('bg-blue-600','text-white'); loginTab.classList.remove('text-gray-300'); registerTab.classList.remove('bg-green-600','text-white'); registerTab.classList.add('text-gray-300'); loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); });
        registerTab.addEventListener('click', () => { registerTab.classList.add('bg-green-600','text-white'); registerTab.classList.remove('text-gray-300'); loginTab.classList.remove('bg-blue-600','text-white'); loginTab.classList.add('text-gray-300'); registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            try { const user = await login(username, password); showChatScreen(user); } catch (err) { showError(err.message); }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            try { const user = await register(username, password); showChatScreen(user); } catch (err) { showError(err.message); }
        });

        guestBtn.addEventListener('click', async () => {
            try { const user = await guestLogin(); showChatScreen(user); } catch (err) { showError(err.message); }
        });

        logoutBtn.addEventListener('click', () => { showAuthScreen(); });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInput.value.trim(); if (!content) return;
            setLoading(true);
            try { const recipient_id = currentRecipient ? currentRecipient.id : null; const message = await sendMessage(content, recipient_id); messageInput.value = ''; updateCharCount(); addMessage(message); } catch (err) { console.error('Failed to send message:', err); showError('Failed to send message'); } finally { setLoading(false); messageInput.focus(); }
        });

        messageInput.addEventListener('input', updateCharCount);
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); messageForm.dispatchEvent(new Event('submit',{bubbles:true,cancelable:true})); } });

        function populateUserSelect() {
            const prev = userSelect.value || '';
            userSelect.innerHTML = '';
            const allOption = document.createElement('option'); allOption.value = ''; allOption.textContent = 'All (global)'; userSelect.appendChild(allOption);
            usersList.forEach(u => { const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.username; userSelect.appendChild(opt); });
            if (prev) { const found = Array.from(userSelect.options).some(o => o.value === prev); if (found) userSelect.value = prev; }
        }

        userSelect.addEventListener('change', () => {
            const val = userSelect.value;
            if (!val) { currentRecipient = null; clearRecipientBtn.classList.add('hidden'); } else { const u = usersList.find(x => String(x.id) === String(val)); if (u) { currentRecipient = { id: u.id, username: u.username }; clearRecipientBtn.classList.remove('hidden'); } else { currentRecipient = null; clearRecipientBtn.classList.add('hidden'); } }
            loadMessages();
        });

        clearRecipientBtn.addEventListener('click', () => { currentRecipient = null; userSelect.value = ''; clearRecipientBtn.classList.add('hidden'); loadMessages(); });

        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                if (document.hidden) { stopPolling(); }
                else {
                    markAsSeen();
                    if (window.PinSystem && PinSystem.isUnlocked()) { loadMessages(); startPolling(); }
                    else if (window.PinSystem && !PinSystem.isUnlocked()) { PinSystem.showOverlayIfLocked(); }
                }
            }
        });

        window.addEventListener('focus', () => { markAsSeen(); if (window.PinSystem && PinSystem.isUnlocked()) loadMessages(); });

        (function notesAppModule() {
            const NOTES_KEY = 'notes_app_v1';
            const lockPanel = document.getElementById('lock-panel');

            function loadNotesFromStorage() {
                try {
                    const raw = localStorage.getItem(NOTES_KEY);
                    if (!raw) return [];
                    return JSON.parse(raw);
                } catch (e) {
                    console.error('Failed to parse notes:', e);
                    return [];
                }
            }
            function saveNotesToStorage(notes) {
                localStorage.setItem(NOTES_KEY, JSON.stringify(notes || []));
            }

            function createNoteObject() {
                return {
                    id: Date.now() + Math.floor(Math.random() * 999),
                    title: 'Untitled',
                    content: '',
                    updatedAt: new Date().toISOString()
                };
            }

            window.openNotesMode = function openNotesMode() {
                const notes = loadNotesFromStorage();

                if (!notes || notes.length === 0) {
                    const sample = createNoteObject();
                    sample.title = 'Weekly Assignments';
                    sample.content = 'DUE NEXT WEDNESDAY: ';
                    notes.push(sample);
                    saveNotesToStorage(notes);
                }

                lockPanel.innerHTML = `
                    <div class="notes-app w-full">
                        <div class="flex gap-4">
                            <div class="notes-sidebar w-1/3 border-r pr-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold">Notes</h3>
                                    <div class="flex gap-2">
                                        <button id="notes-new" class="px-3 py-1 text-sm rounded bg-green-600 hover:bg-green-700">New</button>
                                        <button id="notes-close" class="px-3 py-1 text-sm rounded bg-gray-600 hover:bg-gray-700">Close</button>
                                    </div>
                                </div>
                                <input id="notes-search" placeholder="Search..." class="w-full mb-3 p-2 rounded bg-dark-700 border border-dark-500 text-sm" />
                                <div id="notes-list" style="max-height:420px;overflow:auto;"></div>
                            </div>
                            <div class="notes-editor flex-1 pl-4">
                                <div class="flex items-center justify-between mb-3">
                                    <input id="note-title" class="text-xl p-2 rounded bg-dark-800 border border-dark-500 w-3/4" placeholder="Title" />
                                    <div class="flex gap-2">
                                        <button id="note-delete" class="px-3 py-1 text-sm rounded bg-red-600 hover:bg-red-700">Delete</button>
                                        <button id="note-save" class="px-3 py-1 text-sm rounded bg-blue-600 hover:bg-blue-700">Save</button>
                                    </div>
                                </div>
                                <textarea id="note-content" class="w-full h-72 p-3 rounded bg-dark-700 border border-dark-500" placeholder="Write your note..."></textarea>
                                <div id="note-meta" class="text-xs text-gray-400 mt-2"></div>
                            </div>
                        </div>
                    </div>
                `;

                const notesListEl = document.getElementById('notes-list');
                const titleEl = document.getElementById('note-title');
                const contentEl = document.getElementById('note-content');
                const saveBtn = document.getElementById('note-save');
                const deleteBtn = document.getElementById('note-delete');
                const newBtn = document.getElementById('notes-new');
                const closeBtn = document.getElementById('notes-close');
                const searchEl = document.getElementById('notes-search');
                const metaEl = document.getElementById('note-meta');

                let notesState = loadNotesFromStorage();
                let currentNoteId = notesState[0] && notesState[0].id;

                function renderList(filter = '') {
                    const f = filter.trim().toLowerCase();
                    notesListEl.innerHTML = '';
                    const ordered = notesState.slice().sort((a,b) => b.updatedAt.localeCompare(a.updatedAt));
                    ordered.forEach(n => {
                        if (f && !(n.title + ' ' + n.content).toLowerCase().includes(f)) return;
                        const item = document.createElement('div');
                        item.className = 'note-item p-2 mb-2 rounded hover:bg-dark-800 cursor-pointer border border-dark-600';
                        item.dataset.id = n.id;
                        item.innerHTML = `<div class="flex justify-between items-start"><strong>${escapeHtml(n.title || 'Untitled')}</strong><span class="text-xs text-gray-400">${new Date(n.updatedAt).toLocaleString()}</span></div>
                                          <div class="text-sm text-gray-400 truncate mt-1">${escapeHtml(n.content || '')}</div>`;
                        item.addEventListener('click', () => {
                            loadNoteIntoEditor(n.id);
                        });
                        notesListEl.appendChild(item);
                    });
                    highlightSelected();
                }

                function loadNoteIntoEditor(id) {
                    const note = notesState.find(x => x.id === Number(id));
                    if (!note) return;
                    currentNoteId = note.id;
                    titleEl.value = note.title;
                    contentEl.value = note.content;
                    metaEl.textContent = `Last edited: ${new Date(note.updatedAt).toLocaleString()}`;
                    highlightSelected();
                }

                function highlightSelected() {
                    const items = Array.from(document.querySelectorAll('.note-item'));
                    items.forEach(el => el.classList.toggle('bg-dark-900', Number(el.dataset.id) === Number(currentNoteId)));
                }

                function persistState() {
                    saveNotesToStorage(notesState);
                    renderList(searchEl.value || '');
                }

                function saveCurrentNote() {
                    if (!currentNoteId) return;
                    const idx = notesState.findIndex(x => x.id === Number(currentNoteId));
                    if (idx === -1) return;
                    notesState[idx].title = titleEl.value || 'Untitled';
                    notesState[idx].content = contentEl.value || '';
                    notesState[idx].updatedAt = new Date().toISOString();
                    persistState();
                    metaEl.textContent = `Saved: ${new Date(notesState[idx].updatedAt).toLocaleString()}`;
                }

                function deleteCurrentNote() {
                    if (!currentNoteId) return;
                    if (!confirm('Delete this note?')) return;
                    notesState = notesState.filter(x => x.id !== Number(currentNoteId));
                    if (notesState.length === 0) {
                        const n = createNoteObject();
                        notesState.push(n);
                    }
                    currentNoteId = notesState[0].id;
                    persistState();
                    loadNoteIntoEditor(currentNoteId);
                }

                let autosaveTimer = null;
                function scheduleAutosave() {
                    clearTimeout(autosaveTimer);
                    autosaveTimer = setTimeout(() => {
                        if (currentNoteId) {
                            saveCurrentNote();
                        }
                    }, 700);
                }

                newBtn.addEventListener('click', () => {
                    const n = createNoteObject();
                    notesState.unshift(n);
                    currentNoteId = n.id;
                    persistState();
                    loadNoteIntoEditor(currentNoteId);
                    titleEl.focus();
                });

                saveBtn.addEventListener('click', () => {
                    saveCurrentNote();
                });

                deleteBtn.addEventListener('click', () => {
                    deleteCurrentNote();
                });

                closeBtn.addEventListener('click', () => {

                    window.location.reload();
                });

                titleEl.addEventListener('input', scheduleAutosave);
                contentEl.addEventListener('input', scheduleAutosave);
                searchEl.addEventListener('input', () => renderList(searchEl.value || ''));

                renderList();
                loadNoteIntoEditor(currentNoteId);
            };

            document.addEventListener('dummyPinMatched', (e) => {
                window.openNotesMode && window.openNotesMode();
            });
        })();

        (function () {
            const PIN_HASH_KEY = 'chat_pin_hash_v2';
            const PIN_LENGTH_KEY = 'chat_pin_length_v2';
            const DUMMY_PIN_HASH_KEY = 'chat_dummy_pin_hash_v2';
            const DUMMY_PIN_LENGTH_KEY = 'chat_dummy_pin_length_v2';
            const SESSION_UNLOCK_KEY = 'chat_pin_unlocked_v2';
            const INACTIVITY_MS = 5 * 60 * 1000; 

            const pinBtn = document.getElementById('pin-btn');
            const lockNowBtn = document.getElementById('lock-now-btn');
            const pinModal = document.getElementById('pin-modal');
            const pinModalClose = document.getElementById('pin-modal-close');
            const pinSetupInput = document.getElementById('pin-setup-input');
            const pinSetupConfirm = document.getElementById('pin-setup-confirm');
            const pinDummyInput = document.getElementById('pin-dummy-input');
            const pinDummyConfirm = document.getElementById('pin-dummy-confirm');
            const savePinBtn = document.getElementById('save-pin-btn');
            const removePinBtn = document.getElementById('remove-pin-btn');
            const pinSetupMsg = document.getElementById('pin-setup-msg');

            const lockOverlay = document.getElementById('lock-overlay');
            const pinBoxesContainer = document.getElementById('pin-boxes');
            const pinHidden = document.getElementById('pin-hidden');
            const unlockBtn = document.getElementById('unlock-btn');
            const unlockCancelBtn = document.getElementById('unlock-cancel-btn'); 
            const unlockMsg = document.getElementById('unlock-msg');

            let inactivityTimer = null;
            let inputElems = []; 
            let currentLength = 4;

            function bufferToHex(buffer) {
                const bytes = new Uint8Array(buffer);
                return Array.prototype.map.call(bytes, x => ('00' + x.toString(16)).slice(-2)).join('');
            }

            async function hashPin(pin) {
                const enc = new TextEncoder();
                const data = enc.encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                return bufferToHex(hashBuffer);
            }

            function pinExists() { return !!localStorage.getItem(PIN_HASH_KEY); }
            function getStoredPinLength() { return parseInt(localStorage.getItem(PIN_LENGTH_KEY) || '4', 10); }
            async function savePin(pin) {
                const h = await hashPin(pin);
                localStorage.setItem(PIN_HASH_KEY, h);
                localStorage.setItem(PIN_LENGTH_KEY, String(pin.length));
            }

            function dummyExists() { return !!localStorage.getItem(DUMMY_PIN_HASH_KEY); }
            function getStoredDummyLength() { return parseInt(localStorage.getItem(DUMMY_PIN_LENGTH_KEY) || '0', 10); }
            async function saveDummyPin(dummy) {
                const h = await hashPin(dummy);
                localStorage.setItem(DUMMY_PIN_HASH_KEY, h);
                localStorage.setItem(DUMMY_PIN_LENGTH_KEY, String(dummy.length));
            }
            function removeDummyPin() {
                localStorage.removeItem(DUMMY_PIN_HASH_KEY);
                localStorage.removeItem(DUMMY_PIN_LENGTH_KEY);
            }

            function removePin() {
                localStorage.removeItem(PIN_HASH_KEY);
                localStorage.removeItem(PIN_LENGTH_KEY);

                removeDummyPin();
            }

            async function verifyPin(pin) {
                const stored = localStorage.getItem(PIN_HASH_KEY);
                if (!stored) return false;
                const h = await hashPin(pin);
                return stored === h;
            }
            async function verifyDummyPin(pin) {
                const stored = localStorage.getItem(DUMMY_PIN_HASH_KEY);
                if (!stored) return false;
                const h = await hashPin(pin);
                return stored === h;
            }

            function sessionUnlock() { sessionStorage.setItem(SESSION_UNLOCK_KEY, 'true'); }
            function sessionLock() { sessionStorage.removeItem(SESSION_UNLOCK_KEY); }
            function isSessionUnlocked() { return sessionStorage.getItem(SESSION_UNLOCK_KEY) === 'true'; }
            function isUnlocked() { if (!pinExists()) return true; return isSessionUnlocked(); }

            function buildPinBoxes(len) {
                pinBoxesContainer.innerHTML = '';
                inputElems = [];
                currentLength = len || getStoredPinLength() || 4;
                for (let i = 0; i < currentLength; i++) {
                    const box = document.createElement('div');
                    box.className = 'pin-box flex items-center justify-center text-2xl font-semibold rounded-lg shadow-inner bg-dark-700 border border-dark-500 w-16 h-16 md:w-20 md:h-20 select-none';
                    box.setAttribute('data-index', String(i));
                    box.setAttribute('tabindex', '0');
                    box.textContent = '';
                    pinBoxesContainer.appendChild(box);
                    inputElems.push(box);
                }

                pinHidden.value = '';

                pinHidden.setAttribute('maxlength', Math.max(currentLength, getStoredDummyLength() || 0));
                pinHidden.focus();

                pinHidden.oninput = (e) => {
                    const val = pinHidden.value.replace(/\D/g, '');
                    const clampLen = Math.max(currentLength, getStoredDummyLength() || 0);
                    pinHidden.value = val.slice(0, clampLen); 
                    const displayVal = pinHidden.value.slice(0, currentLength);
                    for (let i = 0; i < currentLength; i++) {
                        inputElems[i].textContent = displayVal[i] || '';
                        inputElems[i].classList.toggle('filled', !!displayVal[i]);
                    }

                    (async () => {
                        const typed = pinHidden.value.replace(/\D/g, '');
                        if (dummyExists() && typed.length === getStoredDummyLength()) {
                            const okDummy = await verifyDummyPin(typed);
                            if (okDummy) {

                                if (typeof window.openNotesMode === 'function') {
                                    window.openNotesMode();
                                } else {
                                    document.dispatchEvent(new CustomEvent('dummyPinMatched', { detail: { pin: typed } }));
                                }

                                pinHidden.value = '';
                                inputElems.forEach(b => b.textContent = '');
                                return;
                            }
                        }

                        if (typed.length >= currentLength) {
                            attemptUnlock(typed.slice(0, currentLength));
                        }
                    })();
                };

                pinHidden.onpaste = (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, Math.max(currentLength, getStoredDummyLength() || 0));
                    pinHidden.value = text;
                    pinHidden.dispatchEvent(new Event('input'));
                };

                inputElems.forEach((box, idx) => {
                    box.addEventListener('click', () => {
                        pinHidden.focus();

                        pinHidden.selectionStart = pinHidden.selectionEnd = pinHidden.value.length;
                    });
                });
            }

            async function attemptUnlock(candidate) {
                unlockMsg.textContent = '';

                if (dummyExists()) {
                    const isDummy = await verifyDummyPin(candidate);
                    if (isDummy) {
                        if (typeof window.openNotesMode === 'function') {
                            window.openNotesMode();
                        } else {
                            document.dispatchEvent(new CustomEvent('dummyPinMatched', { detail: { pin: candidate } }));
                        }
                        pinHidden.value = '';
                        inputElems.forEach(b => b.textContent = '');
                        return;
                    }
                }

                if (!pinExists()) { unlockMsg.textContent = 'No PIN set.'; return; }
                const ok = await verifyPin(candidate);
                if (ok) {
                    sessionUnlock();
                    hideOverlay();
                    loadMessages && typeof loadMessages === 'function' && loadMessages();
                    startPolling && typeof startPolling === 'function' && startPolling();
                    resetInactivityTimer();
                } else {

                    unlockMsg.textContent = 'Incorrect PIN';
                    pinBoxesContainer.classList.add('shake');
                    setTimeout(() => pinBoxesContainer.classList.remove('shake'), 420);
                    pinHidden.value = '';
                    inputElems.forEach(b => b.textContent = '');
                    setTimeout(() => pinHidden.focus(), 150);
                }
            }

            function showOverlay() {
                buildPinBoxes(getStoredPinLength() || 4);
                lockOverlay.classList.remove('hidden');
                stopPolling && typeof stopPolling === 'function' && stopPolling();
                pinHidden.focus();
            }
            function hideOverlay() {
                lockOverlay.classList.add('hidden');
                pinHidden.value = '';
                inputElems.forEach(b => b.textContent = '');
            }

            async function lockNow() {
                if (!pinExists()) {
                    if (!confirm('No PIN set. Would you like to set one now?')) return;
                    openModal();
                    return;
                }
                sessionLock();
                showOverlay();
            }

            let activityBound = false;
            function startActivityTracking() {
                if (activityBound) return;
                const reset = () => resetInactivityTimer();
                ['mousemove','keydown','click','touchstart'].forEach(evt => window.addEventListener(evt, reset, { passive: true }));
                activityBound = true;
                resetInactivityTimer();
            }
            function resetInactivityTimer() { clearInactivityTimer(); inactivityTimer = setTimeout(() => { sessionLock(); showOverlay(); }, INACTIVITY_MS); }
            function clearInactivityTimer() { if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; } }

            function openModal() {
                pinSetupInput.value = '';
                pinSetupConfirm.value = '';
                pinDummyInput.value = '';
                pinDummyConfirm.value = '';
                pinSetupMsg.textContent = '';
                pinModal.classList.remove('hidden');
                setTimeout(() => pinSetupInput.focus(), 80);
            }
            function closeModal() { pinModal.classList.add('hidden'); }

            pinBtn.addEventListener('click', openModal);
            pinModalClose.addEventListener('click', closeModal);

            savePinBtn.addEventListener('click', async () => {
                pinSetupMsg.textContent = '';
                const a = pinSetupInput.value.trim();
                const b = pinSetupConfirm.value.trim();
                const da = pinDummyInput.value.trim();
                const db = pinDummyConfirm.value.trim();

                if (!/^\d{4,8}$/.test(a)) { pinSetupMsg.textContent = 'PIN must be 4–8 digits.'; return; }
                if (a !== b) { pinSetupMsg.textContent = 'PINs do not match.'; return; }

                if (da || db) {
                    if (!/^\d{4,8}$/.test(da)) { pinSetupMsg.textContent = 'Dummy PIN must be 4–8 digits.'; return; }
                    if (da !== db) { pinSetupMsg.textContent = 'Dummy PINs do not match.'; return; }
                    if (da === a) { pinSetupMsg.textContent = 'Dummy PIN should be different from the main PIN.'; return; }
                }

                try {
                    await savePin(a);
                    if (da) {
                        await saveDummyPin(da);
                        pinSetupMsg.textContent = 'PIN and dummy PIN saved.';
                    } else {

                        removeDummyPin();
                        pinSetupMsg.textContent = 'PIN saved. Dummy PIN removed (if any).';
                    }

                    sessionUnlock();
                    closeModal();
                } catch (err) {
                    console.error('Error saving PINs:', err);
                    pinSetupMsg.textContent = 'Failed to save PIN.';
                }
            });

            removePinBtn.addEventListener('click', () => {
                if (!pinExists() && !dummyExists()) { pinSetupMsg.textContent = 'No PIN set.'; return; }
                if (!confirm('Remove the PIN (and any dummy PIN)? This will disable locking.')) return;
                removePin();
                sessionLock();
                pinSetupMsg.textContent = 'PIN removed.';
                closeModal();
            });

            lockNowBtn.addEventListener('click', lockNow);

            unlockBtn.addEventListener('click', () => {
                const val = (document.getElementById('pin-hidden') || {}).value || '';
                const normalized = val.replace(/\D/g, '');
                if (!normalized || normalized.length < (getStoredPinLength() || 4)) {
                    if (dummyExists() && normalized.length >= getStoredDummyLength()) {

                        unlockMsg.textContent = 'Checking...';
                        return;
                    }
                    unlockMsg.textContent = 'Enter full PIN';
                    pinHidden.focus();
                    return;
                }
                attemptUnlock(normalized.slice(0, getStoredPinLength() || 4));
            });

            if (unlockCancelBtn) {
                unlockCancelBtn.addEventListener('click', () => {

                    pinHidden.value = '';
                    inputElems.forEach(b => b.textContent = '');
                    unlockMsg.textContent = '';
                });
            }

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (pinExists()) {
                        sessionLock();
                    }
                } else {
                    if (!isUnlocked()) {
                        showOverlay();
                    } else {
                        loadMessages && typeof loadMessages === 'function' && loadMessages();
                        startPolling && typeof startPolling === 'function' && startPolling();
                        resetInactivityTimer();
                    }
                }
            });

            document.addEventListener('paste', (e) => {
                if (!lockOverlay.classList.contains('hidden')) {
                    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
                    if (!text) return;
                    pinHidden.value = text.slice(0, Math.max(getStoredPinLength() || 4, getStoredDummyLength() || 0));
                    pinHidden.dispatchEvent(new Event('input'));
                }
            });

            if (pinExists() && !isSessionUnlocked()) {
                showOverlay();
            }

            window.PinSystem = {
                isUnlocked,
                showOverlayIfLocked: () => { if (!isUnlocked()) showOverlay(); },
                init: () => { startActivityTracking(); },
                verifyDummyPin,
                dummyExists
            };

            startActivityTracking();
            resetInactivityTimer();
        })();

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            updateCharCount();
            setFavicon(DEFAULT_FAVICON);
            document.title = 'Google';

            if (window.PinSystem && window.PinSystem.init) PinSystem.init();
        });
    </script>
</body>
</html>
