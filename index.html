<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Google</title>

    <!-- Favicon -->
    <link id="favicon" rel="icon" href="https://www.google.com/favicon.ico">

    <!-- Tailwind (keeps your utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <!-- Local stylesheet -->
    <link rel="stylesheet" href="style.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'chakra': ['Chakra Petch', 'monospace']
                    },
                    colors: {
                        'dark': {
                            '900': '#0a0a0a',
                            '800': '#1a1a1a',
                            '700': '#2a2a2a',
                            '600': '#3a3a3a',
                            '500': '#4a4a4a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-100 font-chakra min-h-screen">

    <!-- AUTH (unchanged markup) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full">
            <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 shadow-xl">
                <div class="mb-6">
                    <div class="flex bg-dark-700 rounded-lg p-1">
                        <button id="login-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all text-white bg-blue-600">Login</button>
                        <button id="register-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all text-gray-300 hover:text-white">Register</button>
                    </div>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="login-username" placeholder="Username" required class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg">Login</button>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <input type="text" id="register-username" placeholder="Username (min 3 chars)" required minlength="3" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="Password (min 6 chars)" required minlength="6" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg">Create Account</button>
                </form>

                <div id="guest-section" class="mt-6 pt-6 border-t border-dark-600">
                    <button id="guest-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg">Sign in as Guest</button>
                </div>

                <div id="auth-error" class="mt-4 p-3 bg-red-600 text-white rounded-lg hidden"></div>
            </div>
        </div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen" class="min-h-screen flex flex-col hidden" aria-live="polite">
        <div class="bg-dark-800 border-b border-dark-600 px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <span id="user-display" class="text-gray-300"></span>
                <div>
                    <select id="user-select" class="bg-dark-700 border border-dark-500 text-gray-200 rounded px-3 py-1">
                        <option value="">All (global)</option>
                    </select>
                </div>
            </div>

            <div class="flex items-center space-x-3">
                <button id="clear-recipient-btn" class="text-xs text-gray-400 hover:text-white hidden">Clear DM</button>

                <div class="flex items-center space-x-2">
                    <button id="pin-btn" title="Set / Change PIN" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fas fa-lock-keyhole mr-2"></i>PIN</button>
                    <button id="lock-now-btn" title="Lock now" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fas fa-lock mr-1"></i>Lock</button>
                </div>

                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">Logout</button>
            </div>
        </div>

        <div class="flex-1 flex flex-col">
            <div id="messages-container" class="flex-1 overflow-y-auto bg-dark-900 p-4 space-y-3">
                <div id="empty-state" class="text-center text-gray-400 py-8">
                    <div class="text-4xl mb-4">ðŸ’¬</div>
                    <p>No messages yet. Be the first to say hello!</p>
                </div>
            </div>

            <div class="bg-dark-800 border-t border-dark-600 p-4">
                <form id="message-form" class="flex space-x-3">
                    <div class="flex-1">
                        <input type="text" id="message-input" placeholder="Type your message..." maxlength="500" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none" autocomplete="off">
                    </div>
                    <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                        <span id="send-text">Send</span>
                        <span id="send-loading" class="hidden"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg></span>
                    </button>
                </form>
                <div class="mt-2 text-right">
                    <span id="char-count" class="text-xs text-gray-400">0/500</span>
                </div>
            </div>
        </div>
    </div>

    <!-- PIN SETUP MODAL (centered in screen, neutral colors) -->
    <div id="pin-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
            <div class="flex items-start justify-between">
                <div>
                    <h3 id="pin-modal-title" class="text-lg font-semibold text-white">Set / Change PIN</h3>
                    <p class="text-sm text-gray-400 mt-1">Pick a numeric PIN (4â€“8 digits). The PIN is stored locally as a hash.</p>
                </div>
                <button id="pin-modal-close" class="text-gray-400 hover:text-white" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>

            <form id="pin-setup-form" class="mt-5 space-y-4" onsubmit="return false;">
                <div class="grid grid-cols-1 gap-2">
                    <label class="text-xs text-gray-300">PIN (numbers only)</label>
                    <input id="pin-setup-input" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="Enter new PIN (4â€“8 digits)" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                    <input id="pin-setup-confirm" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="Confirm PIN" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                </div>

                <div class="flex items-center justify-between mt-2">
                    <div class="flex gap-2">
                        <button id="save-pin-btn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save PIN</button>
                        <button id="remove-pin-btn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Remove PIN</button>
                    </div>
                    <div id="pin-setup-msg" class="text-sm text-gray-400"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- FULLSCREEN LOCK OVERLAY (new: full-screen, big boxes, blocking) -->
    <div id="lock-overlay" class="fixed inset-0 z-60 hidden">
        <!-- Full-screen dim + blur -->
        <div class="absolute inset-0 bg-black/75 backdrop-blur-sm pointer-events-auto"></div>

        <!-- Centered lock panel (big, minimal) -->
        <div class="relative z-10 min-h-screen flex items-center justify-center p-6">
            <div class="w-full max-w-2xl mx-auto p-8 rounded-3xl border border-dark-600 bg-gradient-to-b from-dark-800 to-dark-700 shadow-2xl text-center">
                <div class="flex items-center justify-center mb-6">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl">
                        <i class="fas fa-lock"></i>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mb-2">This site is locked</h2>
                <p class="text-sm text-gray-400 mb-6">Enter your PIN to continue</p>

                <!-- PIN boxes container -->
                <div id="pin-boxes" class="flex justify-center gap-4 mb-4"></div>

                <!-- hidden fallback input for paste/focus on mobile keyboards -->
                <input id="pin-hidden" type="text" inputmode="numeric" pattern="\d*" maxlength="32" class="absolute left-[-9999px]">

                <div class="flex items-center justify-center gap-3">
                    <button id="unlock-btn" class="px-6 py-3 rounded bg-blue-600 hover:bg-blue-700 text-white">Unlock</button>
                    <button id="unlock-cancel-btn" class="px-6 py-3 rounded border border-dark-600 text-gray-300 hover:bg-dark-700">Cancel</button>
                </div>

                <div id="unlock-msg" class="mt-4 text-sm text-gray-400"></div>

                <div class="mt-6 text-xs text-gray-500">Locked by PIN â€” autolocks on tab switch or after 5 minutes of inactivity.</div>
            </div>
        </div>
    </div>

    <!-- ORIGINAL SCRIPT + PIN System adapted to box UI -->
    <script>
        // ========== Basic App Config & Elements ==========
        const API_BASE_URL = 'https://chat.nighthawk.work/api';
        const DEFAULT_FAVICON = 'https://www.google.com/favicon.ico';
        const NOTIF_FAVICON = 'https://cdn-icons-png.flaticon.com/512/1827/1827504.png';

        let currentUser = null;
        let lastMessageId = 0;
        let pollInterval = null;
        let config = { guest_login_enabled: true };
        let usersList = [];
        let currentRecipient = null;
        let unseenCount = 0;

        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const guestSection = document.getElementById('guest-section');
        const guestBtn = document.getElementById('guest-btn');
        const authError = document.getElementById('auth-error');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const sendLoading = document.getElementById('send-loading');
        const charCount = document.getElementById('char-count');
        const emptyState = document.getElementById('empty-state');
        const userSelect = document.getElementById('user-select');
        const clearRecipientBtn = document.getElementById('clear-recipient-btn');
        const faviconEl = document.getElementById('favicon');

        function showError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
            setTimeout(() => authError.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
        }

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function updateCharCount() {
            const len = messageInput.value.length;
            charCount.textContent = `${len}/500`;
            if (len > 450) charCount.className = 'text-xs text-red-400';
            else if (len > 400) charCount.className = 'text-xs text-yellow-400';
            else charCount.className = 'text-xs text-gray-400';
        }

        function setLoading(loading) {
            sendButton.disabled = loading;
            messageInput.disabled = loading;
            if (loading) { sendText.classList.add('hidden'); sendLoading.classList.remove('hidden'); }
            else { sendText.classList.remove('hidden'); sendLoading.classList.add('hidden'); }
        }

        function scrollToBottom() { messagesContainer.scrollTop = messagesContainer.scrollHeight; }

        function setFavicon(url) {
            if (faviconEl) faviconEl.href = url;
            else {
                const link = document.createElement('link'); link.id = 'favicon'; link.rel = 'icon'; link.href = url; document.head.appendChild(link);
            }
        }

        function markAsSeen() {
            unseenCount = 0; setFavicon(DEFAULT_FAVICON); document.title = 'Google';
        }
        function incrementUnread() { unseenCount += 1; setFavicon(NOTIF_FAVICON); document.title = `(${unseenCount}) Google`; }

        // ========== API stubs (same as original) ==========
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Request failed');
                return data;
            } catch (err) {
                console.error('API request failed:', err);
                throw err;
            }
        }

        async function loadConfig() {
            try {
                const data = await apiRequest('/config');
                config = data;
                if (!config.guest_login_enabled) guestSection.classList.add('hidden');
            } catch (err) { console.error('Failed to load config:', err); }
        }
        async function login(username, password) {
            const data = await apiRequest('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
            return data.user;
        }
        async function register(username, password) {
            const data = await apiRequest('/auth/register', { method: 'POST', body: JSON.stringify({ username, password }) });
            return data.user;
        }
        async function guestLogin() {
            const data = await apiRequest('/auth/guest', { method: 'POST' });
            return data.user;
        }
        async function sendMessage(content, recipient_id = null) {
            const data = await apiRequest('/messages', { method: 'POST', body: JSON.stringify({ content, user_id: currentUser.id, is_guest: currentUser.is_guest || false, recipient_id }) });
            return data.message;
        }
        async function fetchMessages() {
            const data = await apiRequest(`/messages?last_id=${lastMessageId}`);
            return data.messages;
        }
        async function fetchRecentMessages() { const data = await apiRequest('/messages/recent'); return data.messages; }
        async function loadUsers() {
            try { const data = await apiRequest('/users'); usersList = data.users || []; populateUserSelect(); } catch (err) { console.error('Failed to load users:', err); }
        }
        async function deleteMessageRequest(messageId) {
            try {
                const body = { requesting_user_id: currentUser && currentUser.id, requesting_username: currentUser && currentUser.username };
                const res = await apiRequest(`/messages/${messageId}`, { method: 'DELETE', body: JSON.stringify(body) });
                return res;
            } catch (err) { console.error('Delete message failed:', err); throw err; }
        }

        // ========== Message display (same as before) ==========
        function createMessageElement(message) {
            const d = document.createElement('div');
            d.className = 'message-item fade-in';
            d.dataset.messageId = message.id;
            const isGuest = message.is_guest;
            const avatarChar = isGuest ? 'G' : (message.username && message.username[0] ? message.username[0].toUpperCase() : 'U');
            const avatarColor = isGuest ? 'from-gray-500 to-gray-600' : 'from-blue-500 to-purple-600';
            const ownerBadge = (message.username && message.username.toLowerCase() === 'owner') ? `<i class="fas fa-shield-alt text-white ml-1" title="owner"></i>` : '';
            const dmLabel = (message.recipient_id != null) ? `<span class="dm-badge">DM ${message.recipient_username ? 'â†’ [' + escapeHtml(message.recipient_username) + ']' : ''}</span>` : '';
            let deleteButtonHtml = '';
            if (currentUser && !currentUser.is_guest && currentUser.username && currentUser.username.toLowerCase() === 'owner') {
                deleteButtonHtml = `<button data-delete-id="${message.id}" class="ml-3 text-xs px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-white flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
            }
            d.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 rounded-full bg-gradient-to-r ${avatarColor} flex items-center justify-center text-white text-sm font-medium">${escapeHtml(avatarChar)}</div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-medium text-white">${escapeHtml(message.display_name)}</span>
                            ${ownerBadge}
                            <span class="ml-2">${dmLabel}</span>
                            ${deleteButtonHtml}
                            <span class="text-xs text-gray-400">${formatTime(message.timestamp)}</span>
                        </div>
                        <div class="text-gray-300 break-words">${escapeHtml(message.content)}</div>
                    </div>
                </div>
            `;
            const btn = d.querySelector('button[data-delete-id]');
            if (btn) btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const id = parseInt(btn.getAttribute('data-delete-id'), 10);
                if (!confirm('Delete this message?')) return;
                try { await deleteMessageRequest(id); removeMessageElement(id); } catch (err) { showError('Failed to delete message'); }
            });
            return d;
        }

        function removeMessageElement(messageId) { const el = document.querySelector(`[data-message-id="${messageId}"]`); if (el && el.parentNode) el.parentNode.removeChild(el); }

        function messageMatchesCurrentView(message) {
            if (!currentRecipient) {
                if (message.recipient_id == null) return true;
                if (!currentUser) return false;
                return (message.user_id === currentUser.id) || (message.recipient_id === currentUser.id);
            } else {
                if (!currentUser) return false;
                const a = currentUser.id, b = currentRecipient.id;
                return (message.user_id === a && message.recipient_id === b) || (message.user_id === b && message.recipient_id === a);
            }
        }

        function clearMessages() { messagesContainer.innerHTML = ''; }
        function renderMessages(allMessages) {
            clearMessages();
            if (!allMessages || allMessages.length === 0) { emptyState.classList.remove('hidden'); return; }
            let anyShown = false;
            allMessages.forEach(message => { if (messageMatchesCurrentView(message)) { addMessage(message, false); anyShown = true; } });
            if (!anyShown) emptyState.classList.remove('hidden'); else emptyState.classList.add('hidden');
            scrollToBottom();
        }
        function addMessage(message, scroll = true) {
            if (document.querySelector(`[data-message-id="${message.id}"]`)) return;
            if (!messageMatchesCurrentView(message)) {
                if (document.hidden && currentUser) {
                    const relevant = (!message.recipient_id) || (message.recipient_id === currentUser.id) || (message.user_id === currentUser.id);
                    if (relevant) incrementUnread();
                }
                return;
            }
            emptyState.classList.add('hidden');
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
            setTimeout(() => messageElement.classList.add('message-appear'), 10);
            lastMessageId = Math.max(lastMessageId, message.id);
            if (scroll) scrollToBottom();
        }

        function loadMessages() {
            fetchRecentMessages()
                .then(messages => { if (!messages || messages.length === 0) emptyState.classList.remove('hidden'); else renderMessages(messages); })
                .catch(err => console.error('Failed to load messages:', err));
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => {
                fetchMessages().then(messages => { messages.forEach(m => addMessage(m)); loadUsers(); }).catch(err => console.error('Polling error:', err));
            }, 1000);
        }
        function stopPolling() { if (pollInterval) { clearInterval(pollInterval); pollInterval = null; } }

        // ========== Auth UI wiring ==========
        function showAuthScreen() { authScreen.classList.remove('hidden'); chatScreen.classList.add('hidden'); currentUser = null; stopPolling(); markAsSeen(); }
        function showChatScreen(user) {
            currentUser = user;
            authScreen.classList.add('hidden'); chatScreen.classList.remove('hidden');
            if (user.is_guest) userDisplay.innerHTML = '[guest]';
            else {
                if (user.username && user.username.toLowerCase() === 'owner') userDisplay.innerHTML = `[${escapeHtml(user.username)}] <span class="owner-shield">â˜…</span>`;
                else userDisplay.textContent = `[${user.username}]`;
            }
            loadUsers(); loadMessages(); startPolling(); messageInput.focus(); markAsSeen();
            // If locked, PIN system will show overlay
            if (window.PinSystem && !PinSystem.isUnlocked()) {
                PinSystem.showOverlayIfLocked();
            }
        }

        loginTab.addEventListener('click', () => { loginTab.classList.add('bg-blue-600','text-white'); loginTab.classList.remove('text-gray-300'); registerTab.classList.remove('bg-green-600','text-white'); registerTab.classList.add('text-gray-300'); loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); });
        registerTab.addEventListener('click', () => { registerTab.classList.add('bg-green-600','text-white'); registerTab.classList.remove('text-gray-300'); loginTab.classList.remove('bg-blue-600','text-white'); loginTab.classList.add('text-gray-300'); registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            try { const user = await login(username, password); showChatScreen(user); } catch (err) { showError(err.message); }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            try { const user = await register(username, password); showChatScreen(user); } catch (err) { showError(err.message); }
        });

        guestBtn.addEventListener('click', async () => {
            try { const user = await guestLogin(); showChatScreen(user); } catch (err) { showError(err.message); }
        });

        logoutBtn.addEventListener('click', () => { showAuthScreen(); });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInput.value.trim(); if (!content) return;
            setLoading(true);
            try { const recipient_id = currentRecipient ? currentRecipient.id : null; const message = await sendMessage(content, recipient_id); messageInput.value = ''; updateCharCount(); addMessage(message); } catch (err) { console.error('Failed to send message:', err); showError('Failed to send message'); } finally { setLoading(false); messageInput.focus(); }
        });

        messageInput.addEventListener('input', updateCharCount);
        messageInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); messageForm.dispatchEvent(new Event('submit',{bubbles:true,cancelable:true})); } });

        function populateUserSelect() {
            const prev = userSelect.value || '';
            userSelect.innerHTML = '';
            const allOption = document.createElement('option'); allOption.value = ''; allOption.textContent = 'All (global)'; userSelect.appendChild(allOption);
            usersList.forEach(u => { const opt = document.createElement('option'); opt.value = u.id; opt.textContent = u.username; userSelect.appendChild(opt); });
            if (prev) { const found = Array.from(userSelect.options).some(o => o.value === prev); if (found) userSelect.value = prev; }
        }

        userSelect.addEventListener('change', () => {
            const val = userSelect.value;
            if (!val) { currentRecipient = null; clearRecipientBtn.classList.add('hidden'); } else { const u = usersList.find(x => String(x.id) === String(val)); if (u) { currentRecipient = { id: u.id, username: u.username }; clearRecipientBtn.classList.remove('hidden'); } else { currentRecipient = null; clearRecipientBtn.classList.add('hidden'); } }
            loadMessages();
        });

        clearRecipientBtn.addEventListener('click', () => { currentRecipient = null; userSelect.value = ''; clearRecipientBtn.classList.add('hidden'); loadMessages(); });

        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                if (document.hidden) { stopPolling(); }
                else {
                    markAsSeen();
                    if (window.PinSystem && PinSystem.isUnlocked()) { loadMessages(); startPolling(); }
                    else if (window.PinSystem && !PinSystem.isUnlocked()) { PinSystem.showOverlayIfLocked(); }
                }
            }
        });

        window.addEventListener('focus', () => { markAsSeen(); if (window.PinSystem && PinSystem.isUnlocked()) loadMessages(); });

        // ========== PIN SYSTEM (box-style) ==========
        (function () {
            const PIN_HASH_KEY = 'chat_pin_hash_v2';
            const PIN_LENGTH_KEY = 'chat_pin_length_v2';
            const SESSION_UNLOCK_KEY = 'chat_pin_unlocked_v2';
            const INACTIVITY_MS = 5 * 60 * 1000; // 5 minutes

            const pinBtn = document.getElementById('pin-btn');
            const lockNowBtn = document.getElementById('lock-now-btn');
            const pinModal = document.getElementById('pin-modal');
            const pinModalClose = document.getElementById('pin-modal-close');
            const pinSetupInput = document.getElementById('pin-setup-input');
            const pinSetupConfirm = document.getElementById('pin-setup-confirm');
            const savePinBtn = document.getElementById('save-pin-btn');
            const removePinBtn = document.getElementById('remove-pin-btn');
            const pinSetupMsg = document.getElementById('pin-setup-msg');

            const lockOverlay = document.getElementById('lock-overlay');
            const pinBoxesContainer = document.getElementById('pin-boxes');
            const pinHidden = document.getElementById('pin-hidden');
            const unlockBtn = document.getElementById('unlock-btn');
            const unlockCancelBtn = document.getElementById('unlock-cancel-btn');
            const unlockMsg = document.getElementById('unlock-msg');

            let inactivityTimer = null;
            let inputElems = []; // array of inputs for current lock
            let currentLength = 4;

            function bufferToHex(buffer) {
                const bytes = new Uint8Array(buffer);
                return Array.prototype.map.call(bytes, x => ('00' + x.toString(16)).slice(-2)).join('');
            }

            async function hashPin(pin) {
                const enc = new TextEncoder();
                const data = enc.encode(pin);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                return bufferToHex(hashBuffer);
            }

            function pinExists() { return !!localStorage.getItem(PIN_HASH_KEY); }
            function getStoredPinLength() { return parseInt(localStorage.getItem(PIN_LENGTH_KEY) || '4', 10); }
            async function savePin(pin) {
                const h = await hashPin(pin);
                localStorage.setItem(PIN_HASH_KEY, h);
                localStorage.setItem(PIN_LENGTH_KEY, String(pin.length));
            }
            function removePin() { localStorage.removeItem(PIN_HASH_KEY); localStorage.removeItem(PIN_LENGTH_KEY); }
            async function verifyPin(pin) {
                const stored = localStorage.getItem(PIN_HASH_KEY);
                if (!stored) return false;
                const h = await hashPin(pin);
                return stored === h;
            }
            function sessionUnlock() { sessionStorage.setItem(SESSION_UNLOCK_KEY, 'true'); }
            function sessionLock() { sessionStorage.removeItem(SESSION_UNLOCK_KEY); }
            function isSessionUnlocked() { return sessionStorage.getItem(SESSION_UNLOCK_KEY) === 'true'; }
            function isUnlocked() { if (!pinExists()) return true; return isSessionUnlocked(); }

            // Build big boxes for length
            function buildPinBoxes(len) {
                pinBoxesContainer.innerHTML = '';
                inputElems = [];
                currentLength = len || getStoredPinLength() || 4;
                for (let i = 0; i < currentLength; i++) {
                    const box = document.createElement('div');
                    box.className = 'pin-box flex items-center justify-center text-2xl font-semibold rounded-lg shadow-inner bg-dark-700 border border-dark-500 w-16 h-16 md:w-20 md:h-20 select-none';
                    box.setAttribute('data-index', String(i));
                    box.setAttribute('tabindex', '0');
                    box.textContent = '';
                    pinBoxesContainer.appendChild(box);
                    inputElems.push(box);
                }

                // focus behaviour: we use a hidden input to receive keyboard input (helps on mobile)
                pinHidden.value = '';
                pinHidden.focus();

                // keyboard handling: when user types digits, fill successive boxes
                pinHidden.oninput = (e) => {
                    const val = pinHidden.value.replace(/\D/g, '');
                    pinHidden.value = val.slice(0, currentLength); // clamp
                    for (let i = 0; i < currentLength; i++) {
                        inputElems[i].textContent = val[i] || '';
                        inputElems[i].classList.toggle('filled', !!val[i]);
                    }
                    if (val.length >= currentLength) {
                        attemptUnlock(val);
                    }
                };

                // support paste into hidden
                pinHidden.onpaste = (e) => {
                    e.preventDefault();
                    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '').slice(0, currentLength);
                    pinHidden.value = text;
                    pinHidden.dispatchEvent(new Event('input'));
                };

                // support focusing hidden if user clicks any box
                inputElems.forEach((box, idx) => {
                    box.addEventListener('click', () => {
                        pinHidden.focus();
                        // position caret at end
                        pinHidden.selectionStart = pinHidden.selectionEnd = pinHidden.value.length;
                    });
                });
            }

            async function attemptUnlock(candidate) {
                unlockMsg.textContent = '';
                if (!pinExists()) { unlockMsg.textContent = 'No PIN set.'; return; }
                const ok = await verifyPin(candidate);
                if (ok) {
                    sessionUnlock();
                    hideOverlay();
                    loadMessages();
                    startPolling();
                    resetInactivityTimer();
                } else {
                    // shake animation & clear input
                    unlockMsg.textContent = 'Incorrect PIN';
                    pinBoxesContainer.classList.add('shake');
                    setTimeout(() => pinBoxesContainer.classList.remove('shake'), 420);
                    // clear
                    pinHidden.value = '';
                    inputElems.forEach(b => b.textContent = '');
                    setTimeout(() => pinHidden.focus(), 150);
                }
            }

            function showOverlay() {
                buildPinBoxes(getStoredPinLength() || 4);
                lockOverlay.classList.remove('hidden');
                // block pointer events to the rest because overlay covers whole screen
                stopPolling();
                pinHidden.focus();
            }
            function hideOverlay() {
                lockOverlay.classList.add('hidden');
                pinHidden.value = '';
                inputElems.forEach(b => b.textContent = '');
            }

            // manual lock action
            async function lockNow() {
                if (!pinExists()) {
                    if (!confirm('No PIN set. Would you like to set one now?')) return;
                    openModal();
                    return;
                }
                sessionLock();
                showOverlay();
            }

            // inactivity tracking
            let activityBound = false;
            function startActivityTracking() {
                if (activityBound) return;
                const reset = () => resetInactivityTimer();
                ['mousemove','keydown','click','touchstart'].forEach(evt => window.addEventListener(evt, reset, { passive: true }));
                activityBound = true;
                resetInactivityTimer();
            }
            function resetInactivityTimer() { clearInactivityTimer(); inactivityTimer = setTimeout(() => { sessionLock(); showOverlay(); }, INACTIVITY_MS); }
            function clearInactivityTimer() { if (inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; } }

            // modal UI
            function openModal() {
                pinSetupInput.value = '';
                pinSetupConfirm.value = '';
                pinSetupMsg.textContent = '';
                pinModal.classList.remove('hidden');
                setTimeout(() => pinSetupInput.focus(), 80);
            }
            function closeModal() { pinModal.classList.add('hidden'); }

            // wiring
            pinBtn.addEventListener('click', openModal);
            pinModalClose.addEventListener('click', closeModal);

            savePinBtn.addEventListener('click', async () => {
                pinSetupMsg.textContent = '';
                const a = pinSetupInput.value.trim();
                const b = pinSetupConfirm.value.trim();
                if (!/^\d{4,8}$/.test(a)) { pinSetupMsg.textContent = 'PIN must be 4â€“8 digits.'; return; }
                if (a !== b) { pinSetupMsg.textContent = 'PINs do not match.'; return; }
                await savePin(a);
                pinSetupMsg.textContent = 'PIN saved.';
                // keep session unlocked for now
                sessionUnlock();
                closeModal();
            });

            removePinBtn.addEventListener('click', () => {
                if (!pinExists()) { pinSetupMsg.textContent = 'No PIN set.'; return; }
                if (!confirm('Remove the PIN? This will disable locking.')) return;
                removePin();
                sessionLock();
                pinSetupMsg.textContent = 'PIN removed.';
                closeModal();
            });

            lockNowBtn.addEventListener('click', lockNow);

            unlockBtn.addEventListener('click', () => {
                // try unlocking with current hidden value
                const val = pinHidden.value.replace(/\D/g, '').slice(0, getStoredPinLength() || 4);
                if (!val || val.length < (getStoredPinLength() || 4)) {
                    unlockMsg.textContent = 'Enter full PIN';
                    pinHidden.focus();
                    return;
                }
                attemptUnlock(val);
            });

            unlockCancelBtn.addEventListener('click', () => {
                // clear input but keep overlay visible
                pinHidden.value = '';
                inputElems.forEach(b => b.textContent = '');
                unlockMsg.textContent = '';
            });

            // autolock on tab switch
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (pinExists()) {
                        sessionLock();
                    }
                } else {
                    // when returning, if locked => show overlay and don't fetch messages
                    if (!isUnlocked()) {
                        showOverlay();
                    } else {
                        // if unlocked, fetch immediately
                        loadMessages();
                        startPolling();
                        resetInactivityTimer();
                    }
                }
            });

            // handle paste into the document (for convenience)
            document.addEventListener('paste', (e) => {
                if (!lockOverlay.classList.contains('hidden')) {
                    const text = (e.clipboardData || window.clipboardData).getData('text').replace(/\D/g, '');
                    if (!text) return;
                    pinHidden.value = text.slice(0, getStoredPinLength() || 4);
                    pinHidden.dispatchEvent(new Event('input'));
                }
            });

            // On load: if a PIN exists and session not unlocked -> show overlay so reload requires PIN
            if (pinExists() && !isSessionUnlocked()) {
                // show overlay immediately
                showOverlay();
            }

            // expose small API for other code
            window.PinSystem = {
                isUnlocked,
                showOverlayIfLocked: () => { if (!isUnlocked()) showOverlay(); },
                init: () => { startActivityTracking(); }
            };

            // start tracking
            startActivityTracking();
            resetInactivityTimer();
        })();

        // ========== initialize app on DOM ready ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            updateCharCount();
            setFavicon(DEFAULT_FAVICON);
            document.title = 'Google';

            if (window.PinSystem && window.PinSystem.init) PinSystem.init();
        });
    </script>
</body>
</html>
