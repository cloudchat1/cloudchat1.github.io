<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Online Notepad</title>

    <!-- Favicon -->
    <link id="favicon" rel="icon" href="https://onlinenotepad.org/favicon.ico">

    <!-- Tailwind (keeps your utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link rel="stylesheet" href="style.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'chakra': ['Chakra Petch', 'monospace']
                    },
                    colors: {
                        'dark': {
                            '900': '#0a0a0a',
                            '800': '#1a1a1a',
                            '700': '#2a2a2a',
                            '600': '#3a3a3a',
                            '500': '#4a4a4a'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-100 font-chakra min-h-screen">

    <!-- AUTH (unchanged markup) -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full">
            <div class="bg-dark-800 border border-dark-600 rounded-lg p-8 shadow-xl">
                <div class="mb-6">
                    <div class="flex bg-dark-700 rounded-lg p-1">
                        <button id="login-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all text-white bg-blue-600">Login</button>
                        <button id="register-tab" class="flex-1 py-2 px-4 text-sm font-medium rounded-md transition-all text-gray-300 hover:text-white">Register</button>
                    </div>
                </div>

                <form id="login-form" class="space-y-4">
                    <div>
                        <input type="text" id="login-username" placeholder="Username" required class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <div>
                        <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg">Login</button>
                </form>

                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <input type="text" id="register-username" placeholder="Username (min 3 chars)" required minlength="3" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <div>
                        <input type="password" id="register-password" placeholder="Password (min 6 chars)" required minlength="6" class="w-full px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-4 rounded-lg">Create Account</button>
                </form>

                <div id="guest-section" class="mt-6 pt-6 border-t border-dark-600">
                    <button id="guest-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-medium py-3 px-4 rounded-lg">Sign in as Guest</button>
                </div>

                <div id="auth-error" class="mt-4 p-3 bg-red-600 text-white rounded-lg hidden"></div>
            </div>
        </div>
    </div>

    <!-- CHAT SCREEN -->
    <div id="chat-screen" class="min-h-screen flex flex-col hidden" aria-live="polite">
        <div class="bg-dark-800 border-b border-dark-600 px-6 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <span id="user-display" class="text-gray-300"></span>
                    <select id="status-select" class="user-status-select hidden">
                        <option value="online">ðŸŸ¢ Online</option>
                        <option value="away">ðŸŸ¡ Away</option>
                        <option value="busy">ðŸ”´ Busy</option>
                        <option value="offline">âš« Offline</option>
                    </select>
                </div>
                
                <!-- Chat Mode Navigation -->
                <div class="flex space-x-2 relative">
                    <button id="global-chat-btn" class="px-4 py-2 bg-blue-600 text-white rounded text-sm font-medium">
                        Global
                    </button>
                    <div class="relative">
                        <button id="dms-btn" class="px-4 py-2 bg-dark-700 text-gray-300 rounded text-sm font-medium hover:bg-dark-600">
                            DMs
                        </button>
                        <!-- DMs Dropdown -->
                        <div id="dms-dropdown" class="absolute top-full left-0 mt-2 w-64 bg-dark-800 border border-dark-600 rounded-lg shadow-lg hidden z-50">
                            <div class="p-3 border-b border-dark-600">
                                <h3 class="text-white font-semibold text-sm">Direct Messages</h3>
                            </div>
                            <div id="dms-list" class="max-h-64 overflow-y-auto">
                                <!-- DMs will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="groups-btn" class="px-4 py-2 bg-dark-700 text-gray-300 rounded text-sm font-medium hover:bg-dark-600">
                            Groups
                        </button>
                        <!-- Groups Dropdown -->
                        <div id="groups-dropdown" class="absolute top-full left-0 mt-2 w-64 bg-dark-800 border border-dark-600 rounded-lg shadow-lg hidden z-50">
                            <div class="p-3 border-b border-dark-600">
                                <h3 class="text-white font-semibold text-sm">Group Chats</h3>
                            </div>
                            <div id="groups-list" class="max-h-64 overflow-y-auto">
                                <!-- Groups will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>

            <div class="flex items-center space-x-3">
                <button id="clear-recipient-btn" class="text-xs text-gray-400 hover:text-white hidden">Clear DM</button>

                <div class="flex items-center space-x-2">
                    <button id="create-group-btn" title="Create Group Chat" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700 hidden"><i class="fas fa-users mr-1"></i>Create Group</button>
                    <button id="users-btn" title="View All Users" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fas fa-users mr-1"></i>Users</button>
                    <button id="profile-pic-btn" title="Set Profile Picture" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700 hidden"><i class="fas fa-user-circle mr-1"></i>Avatar</button>
                    <button id="pin-btn" title="Set / Change PIN" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fa-solid fa-keyboard mr-2"></i>PIN</button>
                    <button id="lock-now-btn" title="Lock now" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700"><i class="fas fa-lock mr-1"></i>Lock</button>
                    <button id="admin-btn" title="Admin Controls" class="px-3 py-1 rounded border border-dark-600 text-sm text-gray-300 hover:bg-dark-700 hidden"><i class="fas fa-shield-alt mr-1"></i>Admin</button>
                </div>

                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">Logout</button>
            </div>
        </div>

        <div class="flex-1 flex flex-col">
            <div id="messages-container" class="flex-1 overflow-y-auto bg-dark-900 p-4 space-y-3">
                <div id="empty-state" class="text-center text-gray-400 py-8">
                    <div class="text-4xl mb-4">ðŸ’¬</div>
                    <p>No messages yet. Be the first to say hello!</p>
                </div>
            </div>

            <div class="bg-dark-800 border-t border-dark-600 p-4">
                <form id="message-form" class="flex space-x-3">
                    <div class="flex-1 message-input-container">
                        <div class="flex">
                            <button type="button" id="file-btn" class="file-btn mr-2" title="Upload File">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button type="button" id="gif-btn" class="gif-btn mr-2" title="Send GIF">
                                <i class="fas fa-images"></i>
                            </button>
                            <input type="text" id="message-input" placeholder="Type your message..." maxlength="500" class="flex-1 px-4 py-3 bg-dark-700 border border-dark-500 rounded-lg text-white placeholder-gray-400 focus:outline-none" autocomplete="off">
                        </div>
                        
                        <!-- GIF Browser -->
                        <div id="gif-browser" class="gif-browser hidden">
                            <input type="text" id="gif-search" class="gif-search-input" placeholder="Search for GIFs..." autocomplete="off">
                            <div id="gif-grid" class="gif-grid">
                                <div class="text-center text-gray-400 py-8 col-span-full">
                                    <i class="fas fa-search text-2xl mb-2"></i>
                                    <p>Search for GIFs to send</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mention Autocomplete -->
                        <div id="mention-autocomplete" class="mention-autocomplete hidden">
                            <div id="mention-list" class="mention-list">
                                <!-- User suggestions will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Hidden file input -->
                        <input type="file" id="file-input" class="hidden" accept=".txt,.pdf,.png,.jpg,.jpeg,.gif,.webp,.svg,.mp4,.webm,.mp3,.wav,.ogg,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.zip,.rar,.7z,.tar,.gz" multiple>
                    </div>
                    <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg">
                        <span id="send-text">Send</span>
                        <span id="send-loading" class="hidden"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg></span>
                    </button>
                </form>
                <div class="mt-2 text-right">
                    <span id="char-count" class="text-xs text-gray-400">0/500</span>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- PIN SETUP MODAL (centered in screen, neutral colors) -->
    <div id="pin-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
            <div class="flex items-start justify-between">
                <div>
                    <h3 id="pin-modal-title" class="text-lg font-semibold text-white">Set / Change PIN</h3>
                    <p class="text-sm text-gray-400 mt-1">Set a four digit pin and an optional dummy pin. Dummy pin will open a notes app when entered.</p>
                </div>
                <button id="pin-modal-close" class="text-gray-400 hover:text-white" aria-label="Close"><i class="fas fa-times"></i></button>
            </div>

            <form id="pin-setup-form" class="mt-5 space-y-4" onsubmit="return false;">
                <div class="grid grid-cols-1 gap-2">
                    <label class="text-xs text-gray-300">PIN (numbers only)</label>
                    <input id="pin-setup-input" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="1234.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                    <input id="pin-setup-confirm" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="1234.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">

                    <label class="text-xs text-gray-300 mt-2">Optional â€” Dummy PIN (4â€“8 digits)</label>
                    <input id="pin-dummy-input" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="5678.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                    <input id="pin-dummy-confirm" type="password" inputmode="numeric" pattern="\d*" maxlength="8" placeholder="5678.." class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 placeholder-gray-400 text-white focus:outline-none text-lg tracking-widest">
                </div>

                <div class="flex items-center justify-between mt-2">
                    <div class="flex gap-2">
                        <button id="save-pin-btn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save PIN</button>
                        <button id="remove-pin-btn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Remove PIN</button>
                    </div>
                    <div id="pin-setup-msg" class="text-sm text-gray-400"></div>
                </div>
            </form>
        </div>
    </div>

    <!-- CONTENT MODERATION MODAL -->
    <div id="moderation-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-center justify-center mb-4">
                <div class="w-12 h-12 rounded-xl bg-red-600 flex items-center justify-center text-white text-xl">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <h3 class="text-lg font-semibold text-center mb-2">Message Blocked</h3>
            <p id="moderation-reason" class="text-sm text-gray-300 text-center mb-6"></p>
            <div class="flex justify-center">
                <button id="moderation-ok" class="px-6 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">OK</button>
            </div>
        </div>
    </div>

    <!-- BAN MODAL -->
    <div id="ban-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-center justify-center mb-4">
                <div class="w-12 h-12 rounded-xl bg-red-600 flex items-center justify-center text-white text-xl">
                    <i class="fas fa-gavel"></i>
                </div>
            </div>
            <h3 class="text-lg font-semibold text-center mb-2">Account Banned</h3>
            <p class="text-sm text-gray-300 text-center mb-4">You have been banned from this site.</p>
            <div class="bg-dark-700 rounded-lg p-4 mb-6">
                <h4 class="text-sm font-medium text-white mb-2">Moderator Note:</h4>
                <p id="ban-reason" class="text-sm text-gray-300"></p>
            </div>
            <div class="flex justify-center">
                <button id="ban-ok" class="px-6 py-2 rounded bg-red-600 hover:bg-red-700 text-white">OK</button>
            </div>
        </div>
    </div>

    <!-- PROFILE PICTURE MODAL -->
    <div id="profile-pic-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-2xl rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Set Profile Picture</h3>
                <button id="profile-pic-modal-close" class="text-gray-400 hover:text-white" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <p class="text-sm text-gray-400 mb-3">Search for a GIF from Klipy to use as your profile picture:</p>
                <input type="text" id="profile-pic-search" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400" placeholder="Search for GIFs..." autocomplete="off">
            </div>

            <div id="profile-pic-grid" class="grid grid-cols-4 gap-3 max-h-96 overflow-y-auto mb-4">
                <div class="text-center text-gray-400 py-8 col-span-full">
                    <i class="fas fa-search text-2xl mb-2"></i>
                    <p>Search for GIFs to use as your profile picture</p>
                </div>
            </div>

            <div class="flex justify-between items-center">
                <button id="remove-profile-pic-btn" class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Remove Picture</button>
                <div id="profile-pic-msg" class="text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- ADMIN CONTROLS MODAL -->
    <div id="admin-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Admin Controls</h3>
                <button id="admin-modal-close" class="text-gray-400 hover:text-white" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <h4 class="text-sm font-medium text-white mb-2">Ban User</h4>
                    <input id="ban-username" type="text" placeholder="Username" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400 mb-2">
                    <textarea id="ban-reason-input" placeholder="Reason (optional)" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400 mb-2" rows="3"></textarea>
                    <button id="ban-user-btn" class="w-full px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Ban User</button>
                </div>

                <hr class="border-dark-600">

                <div>
                    <h4 class="text-sm font-medium text-white mb-2">Unban User</h4>
                    <input id="unban-username" type="text" placeholder="Username" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400 mb-2">
                    <button id="unban-user-btn" class="w-full px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">Unban User</button>
                </div>

                <div id="admin-msg" class="text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- CREATE GROUP CHAT MODAL -->
    <div id="create-group-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">Create Group Chat</h3>
                <button id="create-group-modal-close" class="text-gray-400 hover:text-white" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-white mb-2 block">Group Name</label>
                    <input id="create-group-name-input" type="text" placeholder="Enter group name..." maxlength="50" class="w-full p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400">
                </div>

                <div>
                    <label class="text-sm font-medium text-white mb-2 block">Add Members</label>
                    <div id="group-members-list" class="max-h-40 overflow-y-auto border border-dark-500 rounded-lg p-2 bg-dark-700">
                        <!-- User checkboxes will be populated here -->
                    </div>
                </div>

                <div class="flex gap-2">
                    <button id="create-group-submit-btn" class="flex-1 px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Create Group</button>
                    <button id="cancel-group-btn" class="flex-1 px-4 py-2 rounded bg-gray-600 hover:bg-gray-700 text-white">Cancel</button>
                </div>

                <div id="create-group-msg" class="text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- USERS MODAL -->
    <div id="users-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-start justify-between mb-4">
                <h3 class="text-lg font-semibold text-white">All Users</h3>
                <button id="users-modal-close" class="text-gray-400 hover:text-white" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-2 max-h-96 overflow-y-auto">
                <div id="users-list" class="space-y-2">
                    <!-- Users will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- GROUP MANAGEMENT MODAL -->
    <div id="group-management-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="relative w-full max-w-md rounded-2xl p-6 shadow-2xl border border-dark-600 bg-dark-800" role="dialog" aria-modal="true">
            <div class="flex items-start justify-between mb-4">
                <h3 id="group-management-title" class="text-lg font-semibold text-white">Group Management</h3>
                <button id="group-management-modal-close" class="text-gray-400 hover:text-white" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-sm font-medium text-white mb-2 block">Group Name</label>
                    <div class="flex gap-2">
                        <input id="group-name-input" type="text" class="flex-1 p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400">
                        <button id="group-rename-btn" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Rename</button>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-medium text-white mb-2 block">Add Member</label>
                    <div class="flex gap-2">
                        <input id="add-member-input" type="text" placeholder="Enter username..." class="flex-1 p-3 rounded-lg bg-dark-700 border border-dark-500 text-white placeholder-gray-400">
                        <button id="group-add-member-btn" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">Add</button>
                    </div>
                </div>

                <div>
                    <label class="text-sm font-medium text-white mb-2 block">Members</label>
                    <div id="group-members-list" class="max-h-40 overflow-y-auto border border-dark-500 rounded-lg p-2 bg-dark-700 space-y-2">
                        <!-- Members list will be populated here -->
                    </div>
                </div>

                <div class="flex gap-2">
                    <button id="group-delete-btn" class="flex-1 px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Delete Group</button>
                </div>

                <div id="group-management-msg" class="text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- FULLSCREEN LOCK OVERLAY (new: full-screen, big boxes, blocking) -->
    <div id="lock-overlay" class="fixed inset-0 z-60 hidden">
        <!-- Full-screen dim + blur -->
        <div class="absolute inset-0 bg-black/75 backdrop-blur-sm pointer-events-auto"></div>

        <!-- Centered lock panel (big, minimal) -->
        <div class="relative z-10 min-h-screen flex items-center justify-center p-6">
            <div id="lock-panel" class="w-full max-w-2xl mx-auto p-8 rounded-3xl border border-dark-600 bg-[#0f0f0f] shadow-2xl text-center">
                <div class="flex items-center justify-center mb-6">
                    <div class="w-14 h-14 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 flex items-center justify-center text-white text-2xl">
                        <i class="fas fa-lock"></i>
                    </div>
                </div>

                <h2 class="text-2xl font-semibold mb-2">This site is locked</h2>
                <p class="text-sm text-gray-400 mb-6">Enter your PIN to continue</p>

                <!-- PIN boxes container -->
                <div id="pin-boxes" class="flex justify-center gap-4 mb-4"></div>

                <!-- hidden fallback input for paste/focus on mobile keyboards -->
                <input id="pin-hidden" type="text" inputmode="numeric" pattern="\d*" maxlength="32" class="absolute left-[-9999px]">

                <div class="flex items-center justify-center gap-3">
                    <button id="unlock-btn" class="px-6 py-3 rounded bg-blue-600 hover:bg-blue-700 text-white">Unlock</button>
                    <button id="unlock-cancel-btn" class="px-6 py-3 rounded bg-gray-600 hover:bg-gray-700 text-white">Cancel</button>
                </div>

                <div id="unlock-msg" class="mt-4 text-sm text-gray-400"></div>
            </div>
        </div>
    </div>

    <script>

        const API_BASE_URL = 'https://chat.nighthawk.work/api';
        const DEFAULT_FAVICON = 'https://onlinenotepad.org/favicon.ico';
        const NOTIF_FAVICON = 'https://cdn-icons-png.flaticon.com/512/1827/1827504.png';

        let currentUser = null;
        let lastMessageId = 0;
        let pollInterval = null;
        let config = { guest_login_enabled: true };
        let usersList = [];
        let currentRecipient = null;
        let unseenCount = 0;

        const authScreen = document.getElementById('auth-screen');
        const chatScreen = document.getElementById('chat-screen');
        const loginTab = document.getElementById('login-tab');
        const registerTab = document.getElementById('register-tab');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const guestSection = document.getElementById('guest-section');
        const guestBtn = document.getElementById('guest-btn');
        const authError = document.getElementById('auth-error');
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const sendText = document.getElementById('send-text');
        const sendLoading = document.getElementById('send-loading');
        const charCount = document.getElementById('char-count');
        const emptyState = document.getElementById('empty-state');
        const clearRecipientBtn = document.getElementById('clear-recipient-btn');
        const usersBtn = document.getElementById('users-btn');
        const usersModal = document.getElementById('users-modal');
        const usersModalClose = document.getElementById('users-modal-close');
        const usersListEl = document.getElementById('users-list');
        const faviconEl = document.getElementById('favicon');
        const moderationModal = document.getElementById('moderation-modal');
        const moderationReason = document.getElementById('moderation-reason');
        const moderationOk = document.getElementById('moderation-ok');
        const statusSelect = document.getElementById('status-select');
        const banModal = document.getElementById('ban-modal');
        const banReason = document.getElementById('ban-reason');
        const banOk = document.getElementById('ban-ok');
        const adminBtn = document.getElementById('admin-btn');
        const adminModal = document.getElementById('admin-modal');
        const adminModalClose = document.getElementById('admin-modal-close');
        const banUsernameInput = document.getElementById('ban-username');
        const banReasonInput = document.getElementById('ban-reason-input');
        const banUserBtn = document.getElementById('ban-user-btn');
        const unbanUsernameInput = document.getElementById('unban-username');
        const unbanUserBtn = document.getElementById('unban-user-btn');
        const adminMsg = document.getElementById('admin-msg');
        const profilePicBtn = document.getElementById('profile-pic-btn');
        const profilePicModal = document.getElementById('profile-pic-modal');
        const profilePicModalClose = document.getElementById('profile-pic-modal-close');
        const profilePicSearch = document.getElementById('profile-pic-search');
        const profilePicGrid = document.getElementById('profile-pic-grid');
        const removeProfilePicBtn = document.getElementById('remove-profile-pic-btn');
        const profilePicMsg = document.getElementById('profile-pic-msg');

        let currentUserStatus = 'online';
        let lastActivity = Date.now();
        let heartbeatInterval = null;
        let awayTimeout = null;
        const AWAY_TIMEOUT = 5 * 60 * 1000; // 5 minutes
        const HEARTBEAT_INTERVAL = 30 * 1000; // 30 seconds
        
        // Group chat and file upload state
        let currentGroup = null;
        let userGroups = [];
        let pendingFiles = [];
        
        // Chat navigation state
        let currentChatMode = 'global'; // 'global', 'dm', 'group'
        let dmHistory = []; // Track DM conversations
        
        // Load DM history from localStorage
        function loadDMHistory() {
            try {
                const saved = localStorage.getItem('dmHistory');
                if (saved) {
                    dmHistory = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Failed to load DM history:', error);
                dmHistory = [];
            }
        }
        
        // Save DM history to localStorage
        function saveDMHistory() {
            try {
                localStorage.setItem('dmHistory', JSON.stringify(dmHistory));
            } catch (error) {
                console.error('Failed to save DM history:', error);
            }
        }

        function showError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
            setTimeout(() => authError.classList.add('hidden'), 5000);
        }

        function escapeHtml(text) {
            const d = document.createElement('div'); d.textContent = text; return d.innerHTML;
        }

        function parseMentions(text) {
            // Parse @mentions and return HTML with styled mentions
            if (!text) return '';
            
            // Escape HTML first
            const escaped = escapeHtml(text);
            
            // Replace @username patterns with styled mentions
            return escaped.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
        }

        function isUserMentioned(messageContent, currentUsername) {
            if (!messageContent || !currentUsername) return false;
            
            // Check if the message contains @currentUsername (case insensitive)
            const mentionPattern = new RegExp(`@${currentUsername}\\b`, 'i');
            return mentionPattern.test(messageContent);
        }

        // File upload functionality
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'ðŸ“„', 'doc': 'ðŸ“„', 'docx': 'ðŸ“„', 'txt': 'ðŸ“„', 'rtf': 'ðŸ“„',
                'jpg': 'ðŸ–¼ï¸', 'jpeg': 'ðŸ–¼ï¸', 'png': 'ðŸ–¼ï¸', 'gif': 'ðŸ–¼ï¸', 'webp': 'ðŸ–¼ï¸', 'svg': 'ðŸ–¼ï¸', 'bmp': 'ðŸ–¼ï¸', 'ico': 'ðŸ–¼ï¸',
                'mp4': 'ðŸŽ¥', 'webm': 'ðŸŽ¥', 'avi': 'ðŸŽ¥', 'mov': 'ðŸŽ¥', 'mkv': 'ðŸŽ¥', 'flv': 'ðŸŽ¥',
                'mp3': 'ðŸŽµ', 'wav': 'ðŸŽµ', 'ogg': 'ðŸŽµ', 'flac': 'ðŸŽµ', 'aac': 'ðŸŽµ', 'm4a': 'ðŸŽµ',
                'zip': 'ðŸ“¦', 'rar': 'ðŸ“¦', '7z': 'ðŸ“¦', 'tar': 'ðŸ“¦', 'gz': 'ðŸ“¦', 'bz2': 'ðŸ“¦',
                'xls': 'ðŸ“Š', 'xlsx': 'ðŸ“Š', 'ppt': 'ðŸ“Š', 'pptx': 'ðŸ“Š', 'csv': 'ðŸ“Š',
                'html': 'ðŸŒ', 'htm': 'ðŸŒ', 'css': 'ðŸŽ¨', 'js': 'âš¡', 'json': 'ðŸ“‹', 'xml': 'ðŸ“‹',
                'py': 'ðŸ', 'java': 'â˜•', 'cpp': 'âš™ï¸', 'c': 'âš™ï¸', 'cs': 'ðŸ”·', 'php': 'ðŸ˜',
                'exe': 'âš™ï¸', 'msi': 'âš™ï¸', 'dmg': 'ðŸ’¿', 'pkg': 'ðŸ“¦', 'deb': 'ðŸ“¦', 'rpm': 'ðŸ“¦'
            };
            return iconMap[ext] || 'ðŸ“Ž';
        }

        function getFileTypeLabel(filename, mimeType) {
            const ext = filename.split('.').pop().toLowerCase();
            const typeMap = {
                'pdf': 'PDF Document',
                'doc': 'Word Document', 'docx': 'Word Document',
                'txt': 'Text File', 'rtf': 'Rich Text',
                'jpg': 'JPEG Image', 'jpeg': 'JPEG Image', 'png': 'PNG Image', 
                'gif': 'GIF Image', 'webp': 'WebP Image', 'svg': 'SVG Image',
                'mp4': 'MP4 Video', 'webm': 'WebM Video', 'avi': 'AVI Video',
                'mp3': 'MP3 Audio', 'wav': 'WAV Audio', 'ogg': 'OGG Audio',
                'zip': 'ZIP Archive', 'rar': 'RAR Archive', '7z': '7-Zip Archive',
                'xls': 'Excel Spreadsheet', 'xlsx': 'Excel Spreadsheet',
                'ppt': 'PowerPoint Presentation', 'pptx': 'PowerPoint Presentation'
            };
            
            if (typeMap[ext]) {
                return typeMap[ext];
            }
            
            // Fallback to MIME type
            if (mimeType) {
                const mimeParts = mimeType.split('/');
                if (mimeParts.length === 2) {
                    return mimeParts[1].toUpperCase() + ' ' + mimeParts[0].charAt(0).toUpperCase() + mimeParts[0].slice(1);
                }
            }
            
            return ext.toUpperCase() + ' File';
        }

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_BASE_URL}/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Upload failed');
                }
                
                return data.file;
            } catch (err) {
                console.error('File upload failed:', err);
                throw err;
            }
        }

        async function sendFileMessage(file) {
            if (!currentUser) return;
            
            setLoading(true);
            try {
                const fileInfo = await uploadFile(file);
                
                const recipient_id = currentRecipient ? currentRecipient.id : null;
                const group_id = currentGroup ? currentGroup.id : null;
                
                const message = await sendMessage('', recipient_id, group_id, fileInfo);
                addMessage(message, true, true);
                
            } catch (err) {
                console.error('Failed to send file:', err);
                showError(err.message || 'Failed to send file');
            } finally {
                setLoading(false);
            }
        }

        // Group chat functionality
        async function createGroupChat(name, memberIds) {
            if (!currentUser || currentUser.is_guest) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/groups`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        owner_id: currentUser.id,
                        member_ids: memberIds
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to create group');
                }
                
                return data.group;
            } catch (err) {
                console.error('Failed to create group:', err);
                throw err;
            }
        }

        async function loadUserGroups() {
            if (!currentUser || currentUser.is_guest) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/groups/user/${currentUser.id}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load groups');
                }
                
                userGroups = data.groups || [];
                return userGroups;
            } catch (err) {
                console.error('Failed to load user groups:', err);
                return [];
            }
        }

        function showCreateGroupModal() {
            const modal = document.getElementById('create-group-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // Populate members list
            const membersList = document.getElementById('group-members-list');
            membersList.innerHTML = '';
            
            usersList.forEach(user => {
                if (user.id !== currentUser.id) { // Don't include current user
                    const memberItem = document.createElement('div');
                    memberItem.className = 'flex items-center space-x-2 p-2 hover:bg-dark-600 rounded';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = user.id;
                    checkbox.id = `member-${user.id}`;
                    checkbox.className = 'rounded';
                    
                    const label = document.createElement('label');
                    label.htmlFor = `member-${user.id}`;
                    label.className = 'text-white cursor-pointer';
                    label.textContent = user.username;
                    
                    memberItem.appendChild(checkbox);
                    memberItem.appendChild(label);
                    membersList.appendChild(memberItem);
                }
            });
        }

        function hideCreateGroupModal() {
            const modal = document.getElementById('create-group-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            
            // Clear form
            document.getElementById('create-group-name-input').value = '';
            document.getElementById('create-group-msg').textContent = '';
        }

        // Chat navigation functions
        function switchToGlobal() {
            currentChatMode = 'global';
            currentGroup = null;
            currentRecipient = null;
            
            // Update navigation buttons
            document.getElementById('global-chat-btn').classList.remove('bg-dark-700', 'text-gray-300');
            document.getElementById('global-chat-btn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('dms-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('dms-btn').classList.add('bg-dark-700', 'text-gray-300');
            document.getElementById('groups-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('groups-btn').classList.add('bg-dark-700', 'text-gray-300');
            
            // Hide dropdowns
            document.getElementById('groups-dropdown').classList.add('hidden');
            document.getElementById('dms-dropdown').classList.add('hidden');
            
            // Update UI
            document.getElementById('user-display').textContent = currentUser.username;
            document.getElementById('clear-recipient-btn').classList.add('hidden');
            
            // Clear messages and load global messages
            document.getElementById('messages-container').innerHTML = '';
            loadMessages();
        }

        function toggleDMsDropdown() {
            const dropdown = document.getElementById('dms-dropdown');
            dropdown.classList.toggle('hidden');
        }

        function toggleGroupsDropdown() {
            const dropdown = document.getElementById('groups-dropdown');
            dropdown.classList.toggle('hidden');
        }

        function renderDMsList() {
            const dmsList = document.getElementById('dms-list');
            dmsList.innerHTML = '';
            
            if (dmHistory.length === 0) {
                dmsList.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No DMs yet</div>';
                return;
            }
            
            dmHistory.forEach(dm => {
                const dmItem = document.createElement('div');
                dmItem.className = 'flex items-center justify-between p-3 hover:bg-dark-700 cursor-pointer border-b border-dark-600 last:border-b-0';
                if (currentRecipient && currentRecipient.id === dm.id) {
                    dmItem.classList.add('bg-dark-700');
                }
                
                const user = usersList.find(u => u.id === dm.id);
                const status = user ? user.status : 'offline';
                const statusColor = {
                    'online': '#43b581',
                    'away': '#faa61a', 
                    'busy': '#f04747',
                    'offline': '#747f8d'
                }[status] || '#747f8d';
                
                dmItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-semibold">${dm.username.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-dark-800" style="background-color: ${statusColor}"></div>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">${escapeHtml(dm.username)}</div>
                            <div class="text-gray-400 text-xs capitalize">${status}</div>
                        </div>
                    </div>
                `;
                
                dmItem.addEventListener('click', () => {
                    selectDM(dm);
                    document.getElementById('dms-dropdown').classList.add('hidden');
                });
                
                dmsList.appendChild(dmItem);
            });
        }

        function selectDM(user) {
            currentRecipient = user;
            currentGroup = null;
            currentChatMode = 'dm';
            
            // Update navigation buttons
            document.getElementById('global-chat-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('global-chat-btn').classList.add('bg-dark-700', 'text-gray-300');
            document.getElementById('dms-btn').classList.remove('bg-dark-700', 'text-gray-300');
            document.getElementById('dms-btn').classList.add('bg-blue-600', 'text-white');
            document.getElementById('groups-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('groups-btn').classList.add('bg-dark-700', 'text-gray-300');
            
            // Update UI
            document.getElementById('user-display').textContent = `DM: ${user.username}`;
            document.getElementById('clear-recipient-btn').classList.remove('hidden');
            
            // Clear messages and load DM messages
            document.getElementById('messages-container').innerHTML = '';
            loadMessages();
            
            // Update DMs list
            renderDMsList();
        }

        function showUsersModal() {
            usersModal.classList.remove('hidden');
            renderUsersList();
        }

        function hideUsersModal() {
            usersModal.classList.add('hidden');
        }

        function renderUsersList() {
            usersListEl.innerHTML = '';
            
            if (usersList.length === 0) {
                usersListEl.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No users found</div>';
                return;
            }
            
            usersList.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'flex items-center justify-between p-3 hover:bg-dark-700 cursor-pointer rounded border border-dark-600';
                
                const statusColor = {
                    'online': '#43b581',
                    'away': '#faa61a', 
                    'busy': '#f04747',
                    'offline': '#747f8d'
                }[user.status] || '#747f8d';
                
                userItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="relative">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm font-semibold">${user.username.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="absolute -bottom-1 -right-1 w-3 h-3 rounded-full border-2 border-dark-800" style="background-color: ${statusColor}"></div>
                        </div>
                        <div>
                            <div class="text-white font-medium">${escapeHtml(user.username)}</div>
                            <div class="text-gray-400 text-sm capitalize">${user.status}</div>
                        </div>
                    </div>
                    <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded" onclick="startDM(${user.id}, '${escapeHtml(user.username)}')">
                        DM
                    </button>
                `;
                
                usersListEl.appendChild(userItem);
            });
        }

        function startDM(userId, username) {
            const user = { id: userId, username: username };
            
            // Add to DM history if not already there
            if (!dmHistory.find(dm => dm.id === userId)) {
                dmHistory.push(user);
                saveDMHistory(); // Save to localStorage
            }
            
            // Start DM conversation
            selectDM(user);
            hideUsersModal();
        }

        function showGroupManagementModal(group) {
            const modal = document.getElementById('group-management-modal');
            const title = document.getElementById('group-management-title');
            const groupNameInput = document.getElementById('group-name-input');
            const addMemberInput = document.getElementById('add-member-input');
            const membersList = document.getElementById('group-members-list');
            const msg = document.getElementById('group-management-msg');
            
            title.textContent = `Manage: ${group.name}`;
            groupNameInput.value = group.name;
            msg.textContent = '';
            
            // Render members list
            renderGroupMembersList(group);
            
            modal.classList.remove('hidden');
        }

        function hideGroupManagementModal() {
            document.getElementById('group-management-modal').classList.add('hidden');
        }

        function renderGroupMembersList(group) {
            const membersList = document.getElementById('group-members-list');
            membersList.innerHTML = '';
            
            group.members.forEach(memberId => {
                const user = usersList.find(u => u.id === memberId);
                if (!user) return;
                
                const memberItem = document.createElement('div');
                memberItem.className = 'flex items-center justify-between p-2 bg-dark-700 rounded';
                
                const statusColor = {
                    'online': '#43b581',
                    'away': '#faa61a', 
                    'busy': '#f04747',
                    'offline': '#747f8d'
                }[user.status] || '#747f8d';
                
                memberItem.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <div class="relative">
                            <div class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-xs font-semibold">${user.username.charAt(0).toUpperCase()}</span>
                            </div>
                            <div class="absolute -bottom-0.5 -right-0.5 w-2 h-2 rounded-full border border-dark-800" style="background-color: ${statusColor}"></div>
                        </div>
                        <span class="text-white text-sm">${escapeHtml(user.username)}</span>
                        ${memberId === group.owner_id ? '<span class="text-yellow-400 text-xs">(Owner)</span>' : ''}
                    </div>
                    ${memberId !== group.owner_id ? `<button class="text-red-400 hover:text-red-300 text-xs" onclick="removeMemberFromGroup(${group.id}, ${memberId})">Remove</button>` : ''}
                `;
                
                membersList.appendChild(memberItem);
            });
        }

        async function updateGroupName(groupId) {
            const newName = document.getElementById('group-name-input').value.trim();
            if (!newName) return;
            
            try {
                const response = await fetch(`/api/groups/${groupId}/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        new_name: newName,
                        requesting_user_id: currentUser.id 
                    })
                });
                
                if (response.ok) {
                    document.getElementById('group-management-msg').textContent = 'Group renamed successfully!';
                    // Update the group in the list
                    const group = userGroups.find(g => g.id === groupId);
                    if (group) {
                        group.name = newName;
                        renderGroupsList();
                    }
                } else {
                    document.getElementById('group-management-msg').textContent = 'Failed to rename group.';
                }
            } catch (error) {
                document.getElementById('group-management-msg').textContent = 'Error renaming group.';
            }
        }

        async function addMemberToGroup(groupId) {
            const username = document.getElementById('add-member-input').value.trim();
            if (!username) return;
            
            const user = usersList.find(u => u.username.toLowerCase() === username.toLowerCase());
            if (!user) {
                document.getElementById('group-management-msg').textContent = 'User not found.';
                return;
            }
            
            try {
                const response = await fetch(`/api/groups/${groupId}/members`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: user.id,
                        requesting_user_id: currentUser.id 
                    })
                });
                
                if (response.ok) {
                    document.getElementById('add-member-input').value = '';
                    document.getElementById('group-management-msg').textContent = 'Member added successfully!';
                    // Update the group in the list
                    const group = userGroups.find(g => g.id === groupId);
                    if (group && !group.members.includes(user.id)) {
                        group.members.push(user.id);
                        renderGroupMembersList(group);
                    }
                } else {
                    document.getElementById('group-management-msg').textContent = 'Failed to add member.';
                }
            } catch (error) {
                document.getElementById('group-management-msg').textContent = 'Error adding member.';
            }
        }

        async function removeMemberFromGroup(groupId, userId) {
            try {
                const response = await fetch(`/api/groups/${groupId}/members/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        requesting_user_id: currentUser.id 
                    })
                });
                
                if (response.ok) {
                    document.getElementById('group-management-msg').textContent = 'Member removed successfully!';
                    // Update the group in the list
                    const group = userGroups.find(g => g.id === groupId);
                    if (group) {
                        group.members = group.members.filter(id => id !== userId);
                        renderGroupMembersList(group);
                    }
                } else {
                    document.getElementById('group-management-msg').textContent = 'Failed to remove member.';
                }
            } catch (error) {
                document.getElementById('group-management-msg').textContent = 'Error removing member.';
            }
        }

        async function deleteGroup(groupId) {
            if (!confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        requesting_user_id: currentUser.id 
                    })
                });
                
                if (response.ok) {
                    hideGroupManagementModal();
                    // Remove from user groups list
                    userGroups = userGroups.filter(g => g.id !== groupId);
                    renderGroupsList();
                    
                    // If we were in this group, switch to global
                    if (currentGroup && currentGroup.id === groupId) {
                        switchToGlobal();
                    }
                } else {
                    document.getElementById('group-management-msg').textContent = 'Failed to delete group.';
                }
            } catch (error) {
                document.getElementById('group-management-msg').textContent = 'Error deleting group.';
            }
        }

        function renderGroupsList() {
            const groupsList = document.getElementById('groups-list');
            groupsList.innerHTML = '';
            
            if (userGroups.length === 0) {
                groupsList.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No groups yet</div>';
                return;
            }
            
            userGroups.forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'flex items-center justify-between p-3 hover:bg-dark-700 cursor-pointer border-b border-dark-600 last:border-b-0';
                if (currentGroup && currentGroup.id === group.id) {
                    groupItem.classList.add('bg-dark-700');
                }
                
                groupItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <i class="fas fa-users text-white text-sm"></i>
                        </div>
                        <div>
                            <div class="text-white font-medium text-sm">${escapeHtml(group.name)}</div>
                            <div class="text-gray-400 text-xs">${group.members.length} members</div>
                        </div>
                    </div>
                    ${group.owner_id === currentUser.id ? '<button class="group-manage-btn text-gray-400 hover:text-white p-1" title="Manage Group"><i class="fas fa-cog text-xs"></i></button>' : ''}
                `;
                
                groupItem.addEventListener('click', () => {
                    selectGroup(group);
                    document.getElementById('groups-dropdown').classList.add('hidden');
                });
                
                // Add manage button event listener
                const manageBtn = groupItem.querySelector('.group-manage-btn');
                if (manageBtn) {
                    manageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showGroupManagementModal(group);
                    });
                }
                
                groupsList.appendChild(groupItem);
            });
        }

        function selectGroup(group) {
            currentGroup = group;
            currentRecipient = null;
            currentChatMode = 'group';
            
            // Update navigation buttons
            document.getElementById('global-chat-btn').classList.remove('bg-blue-600', 'text-white');
            document.getElementById('global-chat-btn').classList.add('bg-dark-700', 'text-gray-300');
            document.getElementById('groups-btn').classList.remove('bg-dark-700', 'text-gray-300');
            document.getElementById('groups-btn').classList.add('bg-blue-600', 'text-white');
            
            // Update UI
            document.getElementById('user-display').textContent = `Group: ${group.name}`;
            document.getElementById('clear-recipient-btn').classList.add('hidden');
            
            // Clear messages and load group messages
            document.getElementById('messages-container').innerHTML = '';
            loadGroupMessages(group.id);
            
            // Update groups list
            renderGroupsList();
        }

        async function loadGroupMessages(groupId) {
            try {
                const response = await fetch(`${API_BASE_URL}/messages?group_id=${groupId}`, {
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load group messages');
                }
                
                const messages = data.messages || [];
                renderMessages(messages);
                
            } catch (err) {
                console.error('Failed to load group messages:', err);
                showError('Failed to load group messages');
            }
        }

        // Mention autocomplete functionality
        let mentionAutocomplete = {
            isOpen: false,
            selectedIndex: -1,
            currentQuery: '',
            cursorPosition: 0,
            
            show() {
                const autocomplete = document.getElementById('mention-autocomplete');
                autocomplete.classList.remove('hidden');
                this.isOpen = true;
            },
            
            hide() {
                const autocomplete = document.getElementById('mention-autocomplete');
                autocomplete.classList.add('hidden');
                this.isOpen = false;
                this.selectedIndex = -1;
                this.currentQuery = '';
            },
            
            updateSuggestions(query) {
                if (!query || query.length < 1) {
                    this.hide();
                    return;
                }
                
                const filteredUsers = usersList.filter(user => 
                    user.username.toLowerCase().includes(query.toLowerCase()) &&
                    (!currentUser || user.id !== currentUser.id) // Don't suggest current user
                );
                
                if (filteredUsers.length === 0) {
                    this.hide();
                    return;
                }
                
                this.renderSuggestions(filteredUsers);
                this.show();
            },
            
            renderSuggestions(users) {
                const mentionList = document.getElementById('mention-list');
                mentionList.innerHTML = '';
                
                users.forEach((user, index) => {
                    const item = document.createElement('div');
                    item.className = 'mention-item';
                    item.dataset.index = index;
                    
                    const avatarChar = user.username[0] ? user.username[0].toUpperCase() : 'U';
                    const statusEmoji = {
                        'online': 'ðŸŸ¢',
                        'away': 'ðŸŸ¡',
                        'busy': 'ðŸ”´',
                        'offline': 'âš«'
                    };
                    
                    item.innerHTML = `
                        <div class="mention-item-avatar" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            ${avatarChar}
                        </div>
                        <div class="mention-item-username">${escapeHtml(user.username)}</div>
                        <div class="mention-item-status ${user.status}">${user.status}</div>
                    `;
                    
                    item.addEventListener('click', () => this.selectUser(user));
                    mentionList.appendChild(item);
                });
                
                this.selectedIndex = -1;
            },
            
            selectUser(user) {
                const input = document.getElementById('message-input');
                const beforeCursor = input.value.substring(0, this.cursorPosition);
                const afterCursor = input.value.substring(input.selectionStart);
                
                // Find the @query part and replace it
                const atIndex = beforeCursor.lastIndexOf('@');
                const newValue = beforeCursor.substring(0, atIndex) + `@${user.username} ` + afterCursor;
                
                input.value = newValue;
                input.focus();
                
                // Set cursor position after the mention
                const newCursorPos = atIndex + user.username.length + 2;
                input.setSelectionRange(newCursorPos, newCursorPos);
                
                this.hide();
                updateCharCount();
            },
            
            navigateUp() {
                if (!this.isOpen) return;
                
                const items = document.querySelectorAll('.mention-item');
                if (items.length === 0) return;
                
                this.selectedIndex = Math.max(0, this.selectedIndex - 1);
                this.updateSelection();
            },
            
            navigateDown() {
                if (!this.isOpen) return;
                
                const items = document.querySelectorAll('.mention-item');
                if (items.length === 0) return;
                
                this.selectedIndex = Math.min(items.length - 1, this.selectedIndex + 1);
                this.updateSelection();
            },
            
            updateSelection() {
                const items = document.querySelectorAll('.mention-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === this.selectedIndex);
                });
            },
            
            selectCurrent() {
                if (!this.isOpen || this.selectedIndex < 0) return;
                
                const items = document.querySelectorAll('.mention-item');
                if (items[this.selectedIndex]) {
                    items[this.selectedIndex].click();
                }
            }
        };

        function formatTime(timestamp) {
            const d = new Date(timestamp);
            return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        function updateCharCount() {
            const len = messageInput.value.length;
            charCount.textContent = `${len}/500`;
            if (len > 450) charCount.className = 'text-xs text-red-400';
            else if (len > 400) charCount.className = 'text-xs text-yellow-400';
            else charCount.className = 'text-xs text-gray-400';
        }

        function setLoading(loading) {
            sendButton.disabled = loading;
            messageInput.disabled = loading;
            if (loading) { sendText.classList.add('hidden'); sendLoading.classList.remove('hidden'); }
            else { sendText.classList.remove('hidden'); sendLoading.classList.add('hidden'); }
        }

        function scrollToBottom() { window.scrollTo(0, document.body.scrollHeight); }
        
        function smoothScrollToBottom() {
            const container = document.getElementById('messages-container');
            if (container) {
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });
            } else {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }

        function setFavicon(url) {
            if (faviconEl) faviconEl.href = url;
            else {
                const link = document.createElement('link'); link.id = 'favicon'; link.rel = 'icon'; link.href = url; document.head.appendChild(link);
            }
        }

        function showModerationModal(reason) {
            moderationReason.textContent = reason || 'Your message violates our community guidelines and cannot be sent.';
            moderationModal.classList.remove('hidden');
            moderationModal.classList.add('flex');
        }

        function hideModerationModal() {
            moderationModal.classList.add('hidden');
            moderationModal.classList.remove('flex');
        }

        function showBanModal(reason) {
            banReason.textContent = reason || 'The site administrator has not specified a reason for this ban.';
            banModal.classList.remove('hidden');
            banModal.classList.add('flex');
        }

        function hideBanModal() {
            banModal.classList.add('hidden');
            banModal.classList.remove('flex');
        }

        function showAdminModal() {
            adminModal.classList.remove('hidden');
            adminModal.classList.add('flex');
            banUsernameInput.value = '';
            banReasonInput.value = '';
            unbanUsernameInput.value = '';
            adminMsg.textContent = '';
        }

        function hideAdminModal() {
            adminModal.classList.add('hidden');
            adminModal.classList.remove('flex');
        }

        function showProfilePicModal() {
            profilePicModal.classList.remove('hidden');
            profilePicModal.classList.add('flex');
            profilePicSearch.value = '';
            profilePicMsg.textContent = '';
            profilePicGrid.innerHTML = `
                <div class="text-center text-gray-400 py-8 col-span-full">
                    <i class="fas fa-search text-2xl mb-2"></i>
                    <p>Search for GIFs to use as your profile picture</p>
                </div>
            `;
            profilePicSearch.focus();
        }

        function hideProfilePicModal() {
            profilePicModal.classList.add('hidden');
            profilePicModal.classList.remove('flex');
        }

        async function searchProfilePicGifs(query) {
            if (!query.trim()) {
                profilePicGrid.innerHTML = `
                    <div class="text-center text-gray-400 py-8 col-span-full">
                        <i class="fas fa-search text-2xl mb-2"></i>
                        <p>Search for GIFs to use as your profile picture</p>
                    </div>
                `;
                return;
            }
            
            profilePicGrid.innerHTML = `
                <div class="text-center text-gray-400 py-8 col-span-full">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>Searching...</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE_URL}/gifs/search?q=${encodeURIComponent(query)}&limit=20`);
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to search GIFs');
                }
                
                if (data.gifs && data.gifs.length > 0) {
                    profilePicGrid.innerHTML = '';
                    data.gifs.forEach(gif => {
                        const gifItem = document.createElement('div');
                        gifItem.className = 'aspect-square rounded-lg overflow-hidden cursor-pointer transition-transform hover:scale-105 bg-dark-700';
                        gifItem.innerHTML = `<img src="${gif.preview_url || gif.url}" alt="${gif.title}" loading="lazy" class="w-full h-full object-cover">`;
                        gifItem.addEventListener('click', () => setProfilePicture(gif.url));
                        profilePicGrid.appendChild(gifItem);
                    });
                } else {
                    profilePicGrid.innerHTML = `
                        <div class="text-center text-gray-400 py-8 col-span-full">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p>No GIFs found. Try a different search term.</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Profile pic GIF search failed:', err);
                profilePicGrid.innerHTML = `
                    <div class="text-center text-red-400 py-8 col-span-full">
                        <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                        <p>Failed to search GIFs. Please try again.</p>
                    </div>
                `;
            }
        }

        async function setProfilePicture(gifUrl) {
            if (!currentUser || currentUser.is_guest) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile-picture`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        profile_picture_url: gifUrl
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to set profile picture');
                }
                
                profilePicMsg.textContent = 'Profile picture updated!';
                profilePicMsg.className = 'text-sm text-center text-green-400';
                
                // Update user in usersList to reflect the change
                const userIndex = usersList.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    usersList[userIndex].profile_picture = gifUrl;
                }
                
                // Refresh messages to show new profile picture
                loadMessages();
                
                setTimeout(() => {
                    hideProfilePicModal();
                }, 1500);
            } catch (err) {
                console.error('Failed to set profile picture:', err);
                profilePicMsg.textContent = err.message || 'Failed to set profile picture';
                profilePicMsg.className = 'text-sm text-center text-red-400';
            }
        }

        async function removeProfilePicture() {
            if (!currentUser || currentUser.is_guest) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/user/profile-picture`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        profile_picture_url: null
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to remove profile picture');
                }
                
                profilePicMsg.textContent = 'Profile picture removed!';
                profilePicMsg.className = 'text-sm text-center text-green-400';
                
                // Update user in usersList to reflect the change
                const userIndex = usersList.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    usersList[userIndex].profile_picture = null;
                }
                
                // Refresh messages to show default avatar
                loadMessages();
                
                setTimeout(() => {
                    hideProfilePicModal();
                }, 1500);
            } catch (err) {
                console.error('Failed to remove profile picture:', err);
                profilePicMsg.textContent = err.message || 'Failed to remove profile picture';
                profilePicMsg.className = 'text-sm text-center text-red-400';
            }
        }

        function markAsSeen() {
            unseenCount = 0; setFavicon(DEFAULT_FAVICON); document.title = 'Online Notepad';
        }
        function incrementUnread() { unseenCount += 1; setFavicon(NOTIF_FAVICON); document.title = `(${unseenCount}) Online Notepad`; }

        function updateUserStatus(newStatus, broadcast = true) {
            if (currentUser && currentUser.is_guest) return; // Guests don't have status
            
            const oldStatus = currentUserStatus;
            currentUserStatus = newStatus;
            statusSelect.value = newStatus;
            
            // Store status in localStorage
            if (currentUser && !currentUser.is_guest) {
                localStorage.setItem(`user_status_${currentUser.username}`, currentUserStatus);
            }
            
            // Broadcast status change if needed
            if (broadcast && oldStatus !== newStatus) {
                sendHeartbeat();
            }
        }

        function resetAwayTimer() {
            lastActivity = Date.now();
            
            // If currently away due to inactivity, switch back to online
            if (currentUserStatus === 'away' && currentUser && !currentUser.is_guest) {
                updateUserStatus('online');
            }
            
            // Clear existing away timeout
            if (awayTimeout) {
                clearTimeout(awayTimeout);
            }
            
            // Set new away timeout
            awayTimeout = setTimeout(() => {
                if (currentUserStatus === 'online' && !document.hidden) {
                    updateUserStatus('away');
                }
            }, AWAY_TIMEOUT);
        }

        async function sendHeartbeat() {
            if (!currentUser || currentUser.is_guest) return;
            
            try {
                await apiRequest('/heartbeat', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser.id,
                        username: currentUser.username,
                        status: currentUserStatus,
                        timestamp: Date.now()
                    })
                });
            } catch (err) {
                console.warn('Heartbeat failed:', err);
            }
        }

        function startHeartbeat() {
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (!currentUser || currentUser.is_guest) return;
            
            // Send initial heartbeat
            sendHeartbeat();
            
            // Set up regular heartbeat
            heartbeatInterval = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            if (awayTimeout) {
                clearTimeout(awayTimeout);
                awayTimeout = null;
            }
        }

        async function apiRequest(endpoint, options = {}) {

            try {

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Request failed');
                return data;
            } catch (err) {
                console.warn('API request failed (stubbed):', err);

                if (endpoint.startsWith('/config')) return { guest_login_enabled: true };
                if (endpoint.startsWith('/auth/login') || endpoint.startsWith('/auth/register') || endpoint.startsWith('/auth/guest')) {
                    return { user: { id: Date.now(), username: 'guest-' + Math.floor(Math.random()*9999), is_guest: true } };
                }
                if (endpoint.startsWith('/messages')) return { messages: [] };
                if (endpoint.startsWith('/users')) return { users: [] };
                return {};
            }
        }

        async function loadConfig() {
            try {
                const data = await apiRequest('/config');
                config = data;
                if (!config.guest_login_enabled) guestSection.classList.add('hidden');
            } catch (err) { console.error('Failed to load config:', err); }
        }
        async function login(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.banned && data.ban_info) {
                        showBanModal(data.ban_info.reason);
                        // Set cookie ban from JavaScript
                        document.cookie = `banned_user=${data.ban_info.user_id}; max-age=${365*24*60*60}; path=/`;
                        return null;
                    }
                    throw new Error(data.error || 'Login failed');
                }
                
                return data.user;
            } catch (err) {
                if (err.name !== 'TypeError') { // Don't handle network errors here
                    throw err;
                }
                // Fallback to original method for network issues
                const data = await apiRequest('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
                return data.user;
            }
        }
        async function register(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.banned && data.ban_info) {
                        showBanModal(data.ban_info.reason);
                        return null;
                    }
                    throw new Error(data.error || 'Registration failed');
                }
                
                return data.user;
            } catch (err) {
                if (err.name !== 'TypeError') { // Don't handle network errors here
                    throw err;
                }
                // Fallback to original method for network issues
                const data = await apiRequest('/auth/register', { method: 'POST', body: JSON.stringify({ username, password }) });
                return data.user;
            }
        }
        async function guestLogin() {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/guest`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.banned && data.ban_info) {
                        showBanModal(data.ban_info.reason);
                        return null;
                    }
                    throw new Error(data.error || 'Guest login failed');
                }
                
                return data.user;
            } catch (err) {
                if (err.name !== 'TypeError') { // Don't handle network errors here
                    throw err;
                }
                // Fallback to original method for network issues
                const data = await apiRequest('/auth/guest', { method: 'POST' });
                return data.user;
            }
        }
        async function sendMessage(content, recipient_id = null, group_id = null, file_attachment = null) {
            try {
                const response = await fetch(`${API_BASE_URL}/messages`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        content, 
                        user_id: currentUser.id, 
                        is_guest: currentUser.is_guest || false, 
                        recipient_id,
                        group_id,
                        file_attachment,
                        status: currentUserStatus 
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    if (data.blocked) {
                        // Throw error with the full response data for moderation handling
                        const error = new Error(JSON.stringify(data));
                        throw error;
                    }
                    throw new Error(data.error || 'Request failed');
                }
                
                return data.message || { 
                    id: Date.now(), 
                    display_name: currentUser ? currentUser.username : 'you', 
                    username: currentUser ? currentUser.username : 'you', 
                    is_guest: currentUser ? currentUser.is_guest : true, 
                    content, 
                    timestamp: Date.now(),
                    status: currentUserStatus 
                };
            } catch (err) {
                // Re-throw the error to be handled by the caller
                throw err;
            }
        }
        async function fetchMessages() {
            let url = `/messages?last_id=${lastMessageId}`;
            
            // Add query parameters based on current chat mode
            if (currentChatMode === 'dm' && currentRecipient) {
                url += `&recipient_id=${currentRecipient.id}`;
            } else if (currentChatMode === 'group' && currentGroup) {
                url += `&group_id=${currentGroup.id}`;
            }
            
            const data = await apiRequest(url);
            return data.messages || [];
        }
        async function fetchRecentMessages() { 
            let url = '/messages/recent';
            
            // Add query parameters based on current chat mode
            if (currentChatMode === 'dm' && currentRecipient) {
                url += `?recipient_id=${currentRecipient.id}`;
            } else if (currentChatMode === 'group' && currentGroup) {
                url += `?group_id=${currentGroup.id}`;
            }
            
            const data = await apiRequest(url); 
            return data.messages || []; 
        }
        async function loadUsers() {
            try { const data = await apiRequest('/users'); usersList = data.users || []; } catch (err) { console.error('Failed to load users:', err); }
        }
        async function deleteMessageRequest(messageId) {
            try {
                const body = { requesting_user_id: currentUser && currentUser.id, requesting_username: currentUser && currentUser.username };
                const res = await apiRequest(`/messages/${messageId}`, { method: 'DELETE', body: JSON.stringify(body) });
                return res;
            } catch (err) { console.error('Delete message failed:', err); throw err; }
        }

        function createMessageElement(message) {
            const d = document.createElement('div');
            d.className = 'message-item fade-in';
            d.dataset.messageId = message.id;
            
            // Check if current user is mentioned in this message
            const isMentioned = currentUser && !currentUser.is_guest && 
                               isUserMentioned(message.content, currentUser.username);
            
            if (isMentioned) {
                d.classList.add('mentioned-message');
            }
            const isGuest = message.is_guest;
            const avatarChar = isGuest ? 'G' : (message.username && message.username[0] ? message.username[0].toUpperCase() : 'U');
            const avatarColor = isGuest ? 'from-gray-500 to-gray-600' : 'from-blue-500 to-purple-600';
            const ownerBadge = (message.username && message.username.toLowerCase() === 'owner') ? `<i class="fas fa-shield-alt text-white ml-1" title="owner"></i>` : '';
            const dmLabel = (message.recipient_id != null) ? `<span class="dm-badge">DM ${message.recipient_username ? 'â†’ ' + escapeHtml(message.recipient_username) : ''}</span>` : '';
            const groupLabel = (message.group_id != null) ? `<span class="group-badge">Group: ${message.group_name ? escapeHtml(message.group_name) : 'Unknown'}</span>` : '';
            
            // Status indicator for non-guest users - use current status from usersList
            let currentStatus = 'offline';
            if (!isGuest && message.user_id) {
                const currentUserData = usersList.find(u => u.id === message.user_id);
                currentStatus = currentUserData ? currentUserData.status : 'offline';
            }
            const statusDot = !isGuest ? `<div class="status-dot status-${currentStatus}"></div>` : '';
            
            // Profile picture logic - use profile_picture from message data first
            let avatarHtml;
            if (!isGuest && message.profile_picture) {
                avatarHtml = `<img src="${escapeHtml(message.profile_picture)}" alt="Profile" class="w-8 h-8 rounded-full object-cover">`;
            } else if (!isGuest && message.user_id) {
                // Fallback to usersList lookup for older messages without profile_picture field
                const userData = usersList.find(u => u.id === message.user_id);
                if (userData && userData.profile_picture) {
                    avatarHtml = `<img src="${escapeHtml(userData.profile_picture)}" alt="Profile" class="w-8 h-8 rounded-full object-cover">`;
                } else {
                    avatarHtml = `<div class="w-8 h-8 rounded-full bg-gradient-to-r ${avatarColor} flex items-center justify-center text-white text-sm font-medium">${escapeHtml(avatarChar)}</div>`;
                }
            } else {
                avatarHtml = `<div class="w-8 h-8 rounded-full bg-gradient-to-r ${avatarColor} flex items-center justify-center text-white text-sm font-medium">${escapeHtml(avatarChar)}</div>`;
            }
            
            let deleteButtonHtml = '';
            if (currentUser && !currentUser.is_guest && currentUser.username && currentUser.username.toLowerCase() === 'owner') {
                deleteButtonHtml = `<button data-delete-id="${message.id}" class="ml-3 text-xs px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-white flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>`;
            }
            
            // Check if message content is a GIF URL
            const isGifMessage = message.content && (message.content.startsWith('http') && (message.content.includes('.gif') || message.content.includes('klipy.com') || message.content.includes('giphy.com')));
            
            let messageContent = '';
            
            // Handle GIF messages
            if (isGifMessage) {
                messageContent = `
                    <div class="gif-message">
                        <img src="${escapeHtml(message.content)}" alt="GIF" loading="lazy">
                        <div class="gif-overlay">
                            <i class="fas fa-play"></i> Hover to play
                        </div>
                    </div>
                `;
            }
            
            // Handle file attachments
            if (message.file_attachment) {
                const file = message.file_attachment;
                const fileIcon = getFileIcon(file.filename);
                const fileSize = formatFileSize(file.size);
                const fileUrl = `${API_BASE_URL.replace("api", "") + file.url}`;
                
                // Check if it's an image
                const isImage = /\.(jpg|jpeg|png|gif|webp|svg)$/i.test(file.filename);
                
                // Determine file type category
                const ext = file.filename.split('.').pop().toLowerCase();
                let fileTypeCategory = 'document';
                if (isImage) fileTypeCategory = 'image';
                else if (['mp4', 'webm', 'avi', 'mov', 'mkv', 'flv'].includes(ext)) fileTypeCategory = 'video';
                else if (['mp3', 'wav', 'ogg', 'flac', 'aac', 'm4a'].includes(ext)) fileTypeCategory = 'audio';
                else if (['zip', 'rar', '7z', 'tar', 'gz', 'bz2'].includes(ext)) fileTypeCategory = 'archive';
                
                if (isImage) {
                    // Discord-style image embed
                    messageContent += `
                        <div class="file-attachment image-attachment" data-file-type="${fileTypeCategory}">
                            <div class="image-preview">
                                <img src="${fileUrl}" alt="${escapeHtml(file.filename)}" loading="lazy" onclick="window.open('${fileUrl}', '_blank')">
                            </div>
                            <div class="file-info">
                                <div class="file-icon">${fileIcon}</div>
                                <div class="file-details">
                                    <div class="file-name">
                                        <a href="${fileUrl}" target="_blank" rel="noopener noreferrer">
                                            ${escapeHtml(file.filename)}
                                        </a>
                                    </div>
                                    <div class="file-size">${fileSize}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Discord-style file embed for non-images
                    const fileTypeLabel = getFileTypeLabel(file.filename, file.type);
                    messageContent += `
                        <div class="file-attachment document-attachment" data-file-type="${fileTypeCategory}">
                            <div class="file-info">
                                <div class="file-icon">${fileIcon}</div>
                                <div class="file-details">
                                    <div class="file-name">
                                        <a href="${fileUrl}" target="_blank" rel="noopener noreferrer">
                                            ${escapeHtml(file.filename)}
                                        </a>
                                    </div>
                                    <div class="file-meta">
                                        <span class="file-size">${fileSize}</span>
                                        <span class="file-type">${fileTypeLabel}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="file-actions">
                                <a href="${fileUrl}" target="_blank" rel="noopener noreferrer" class="download-btn" title="Download ${escapeHtml(file.filename)}">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        </div>
                    `;
                }
            }

            
            // Handle text content
            if (message.content && !isGifMessage) {
                messageContent += `<div class="text-gray-300 break-words">${parseMentions(message.content)}</div>`;
            }
            
            d.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 status-indicator">
                        ${avatarHtml}
                        ${statusDot}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="font-medium text-white">${escapeHtml(message.display_name)}</span>
                            ${ownerBadge}
                            <span class="ml-2">${dmLabel}</span>
                            <span class="ml-2">${groupLabel}</span>
                            ${deleteButtonHtml}
                            <span class="text-xs text-gray-400">${formatTime(message.timestamp)}</span>
                        </div>
                        ${messageContent}
                    </div>
                </div>
            `;
            const btn = d.querySelector('button[data-delete-id]');
            if (btn) btn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const id = parseInt(btn.getAttribute('data-delete-id'), 10);
                if (!confirm('Delete this message?')) return;
                try { await deleteMessageRequest(id); removeMessageElement(id); } catch (err) { showError('Failed to delete message'); }
            });
            return d;
        }

        function removeMessageElement(messageId) { const el = document.querySelector(`[data-message-id="${messageId}"]`); if (el && el.parentNode) el.parentNode.removeChild(el); }

        function messageMatchesCurrentView(message) {
            if (!currentRecipient) {
                if (message.recipient_id == null) return true;
                if (!currentUser) return false;
                return (message.user_id === currentUser.id) || (message.recipient_id === currentUser.id);
            } else {
                if (!currentUser) return false;
                const a = currentUser.id, b = currentRecipient.id;
                return (message.user_id === a && message.recipient_id === b) || (message.user_id === b && message.recipient_id === a);
            }
        }

        function clearMessages() { messagesContainer.innerHTML = ''; }
        function renderMessages(allMessages) {
            clearMessages();
            if (!allMessages || allMessages.length === 0) { emptyState.classList.remove('hidden'); return; }
            let anyShown = false;
            allMessages.forEach(message => { 
                if (messageMatchesCurrentView(message)) { 
                    addMessage(message, false, false); // Don't animate when loading existing messages
                    anyShown = true; 
                } 
            });
            if (!anyShown) emptyState.classList.remove('hidden'); else emptyState.classList.add('hidden');
            // Use smooth scroll for initial load
            setTimeout(() => smoothScrollToBottom(), 100);
        }
        function addMessage(message, scroll = true, animate = true) {
            if (document.querySelector(`[data-message-id="${message.id}"]`)) return;
            if (!messageMatchesCurrentView(message)) {
                if (document.hidden && currentUser) {
                    const relevant = (!message.recipient_id) || (message.recipient_id === currentUser.id) || (message.user_id === currentUser.id);
                    if (relevant) incrementUnread();
                }
                return;
            }
            emptyState.classList.add('hidden');
            const messageElement = createMessageElement(message);
            messagesContainer.appendChild(messageElement);
            
            // Only animate if it's a new message (not loading existing ones)
            if (animate) {
                setTimeout(() => messageElement.classList.add('message-appear'), 10);
            }
            
            lastMessageId = Math.max(lastMessageId, message.id);
            
            // Smooth scroll to bottom
            if (scroll) {
                smoothScrollToBottom();
            }
        }

        function loadMessages() {
            fetchRecentMessages()
                .then(messages => { if (!messages || messages.length === 0) emptyState.classList.remove('hidden'); else renderMessages(messages); })
                .catch(err => console.error('Failed to load messages:', err));
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(() => {
                fetchMessages().then(messages => { 
                    messages.forEach(m => addMessage(m, true, true)); // Animate new messages from polling
                    loadUsers(); 
                }).catch(err => console.error('Polling error:', err));
            }, 1000);
        }
        function stopPolling() { if (pollInterval) { clearInterval(pollInterval); pollInterval = null; } }

        function showAuthScreen() { 
            authScreen.classList.remove('hidden'); 
            chatScreen.classList.add('hidden'); 
            stopHeartbeat();
            currentUser = null; 
            stopPolling(); 
            markAsSeen(); 
        }
        function showChatScreen(user) {
            currentUser = user;
            authScreen.classList.add('hidden'); chatScreen.classList.remove('hidden');
            if (user.is_guest) {
                userDisplay.innerHTML = 'guest';
                statusSelect.classList.add('hidden');
                profilePicBtn.classList.add('hidden');
            } else {
                // Load saved status if available
                const savedStatus = localStorage.getItem(`user_status_${user.username}`);
                if (savedStatus && ['online', 'away', 'busy', 'offline'].includes(savedStatus)) {
                    currentUserStatus = savedStatus;
                }
                
                if (user.username && user.username.toLowerCase() === 'owner') {
                    userDisplay.innerHTML = `${escapeHtml(user.username)} <span class="owner-shield">â˜…</span>`;
                    adminBtn.classList.remove('hidden');
                } else {
                    userDisplay.textContent = user.username;
                    adminBtn.classList.add('hidden');
                }
                statusSelect.classList.remove('hidden');
                statusSelect.value = currentUserStatus;
                profilePicBtn.classList.remove('hidden');
                document.getElementById('create-group-btn').classList.remove('hidden');
                
                // Start status tracking
                startHeartbeat();
                resetAwayTimer();
                
                // Load user groups and set up navigation
                loadUserGroups().then(() => {
                    renderGroupsList();
                });
                
                // Load DM history and initialize DMs list
                loadDMHistory();
                renderDMsList();
                
                // Set initial chat mode
                switchToGlobal();
            }
            loadUsers(); loadMessages(); startPolling(); messageInput.focus(); markAsSeen();
            if (window.PinSystem && !PinSystem.isUnlocked()) {
                PinSystem.showOverlayIfLocked();
            }
        }

        loginTab.addEventListener('click', () => { loginTab.classList.add('bg-blue-600','text-white'); loginTab.classList.remove('text-gray-300'); registerTab.classList.remove('bg-green-600','text-white'); registerTab.classList.add('text-gray-300'); loginForm.classList.remove('hidden'); registerForm.classList.add('hidden'); });
        registerTab.addEventListener('click', () => { registerTab.classList.add('bg-green-600','text-white'); registerTab.classList.remove('text-gray-300'); loginTab.classList.remove('bg-blue-600','text-white'); loginTab.classList.add('text-gray-300'); registerForm.classList.remove('hidden'); loginForm.classList.add('hidden'); });

        async function banUser(username, reason) {
            if (!currentUser || currentUser.username.toLowerCase() !== 'owner') {
                throw new Error('Unauthorized');
            }
            
            const data = await apiRequest('/admin/ban', {
                method: 'POST',
                body: JSON.stringify({
                    admin_username: currentUser.username,
                    target_username: username,
                    reason: reason
                })
            });
            return data;
        }

        async function unbanUser(username) {
            if (!currentUser || currentUser.username.toLowerCase() !== 'owner') {
                throw new Error('Unauthorized');
            }
            
            const data = await apiRequest('/admin/unban', {
                method: 'POST',
                body: JSON.stringify({
                    admin_username: currentUser.username,
                    target_username: username
                })
            });
            return data;
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (preventBannedActions()) return;
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            try { const user = await login(username, password); if (user) showChatScreen(user); } catch (err) { showError(err.message); }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (preventBannedActions()) return;
            const username = document.getElementById('register-username').value.trim();
            const password = document.getElementById('register-password').value;
            try { const user = await register(username, password); if (user) showChatScreen(user); } catch (err) { showError(err.message); }
        });

        guestBtn.addEventListener('click', async () => {
            if (preventBannedActions()) return;
            try { const user = await guestLogin(); if (user) showChatScreen(user); } catch (err) { showError(err.message); }
        });

        logoutBtn.addEventListener('click', () => { showAuthScreen(); });

        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const content = messageInput.value.trim(); if (!content) return;
            setLoading(true);
            try { 
                const recipient_id = currentRecipient ? currentRecipient.id : null;
                const group_id = currentGroup ? currentGroup.id : null;
                const message = await sendMessage(content, recipient_id, group_id); 
                messageInput.value = ''; 
                updateCharCount(); 
                addMessage(message, true, true); // Animate sent messages 
            } catch (err) { 
                console.error('Failed to send message:', err); 
                if (err.message && err.message.includes('Account banned')) {
                    // Handle ban during message sending
                    try {
                        const errorData = JSON.parse(err.message);
                        if (errorData.ban_info) {
                            showBanModal(errorData.ban_info.reason);
                            return;
                        }
                    } catch {}
                    showBanModal('Your account has been banned.');
                } else if (err.message && err.message.includes('blocked by content filter')) {
                    // Parse the error response to get the reason
                    try {
                        const errorData = JSON.parse(err.message);
                        showModerationModal(errorData.reason);
                    } catch {
                        showModerationModal('Your message was blocked by our content filter.');
                    }
                } else {
                    showError('Failed to send message'); 
                }
            } finally { 
                setLoading(false); 
                messageInput.focus(); 
            }
        });

        messageInput.addEventListener('input', (e) => {
            updateCharCount();
            
            // Handle mention autocomplete
            const cursorPos = e.target.selectionStart;
            const text = e.target.value;
            
            // Find if we're typing after an @ symbol
            const beforeCursor = text.substring(0, cursorPos);
            const atMatch = beforeCursor.match(/@(\w*)$/);
            
            if (atMatch) {
                const query = atMatch[1];
                mentionAutocomplete.cursorPosition = cursorPos;
                mentionAutocomplete.updateSuggestions(query);
            } else {
                mentionAutocomplete.hide();
            }
        });
        
        messageInput.addEventListener('keydown', (e) => {
            if (mentionAutocomplete.isOpen) {
                if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    mentionAutocomplete.navigateUp();
                    return;
                } else if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    mentionAutocomplete.navigateDown();
                    return;
                } else if (e.key === 'Enter' || e.key === 'Tab') {
                    e.preventDefault();
                    mentionAutocomplete.selectCurrent();
                    return;
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    mentionAutocomplete.hide();
                    return;
                }
            }
            
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit',{bubbles:true,cancelable:true}));
            }
        });
        
        // Hide mention autocomplete when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.message-input-container') && !e.target.closest('.mention-autocomplete')) {
                mentionAutocomplete.hide();
            }
        });

        // File upload functionality
        const fileBtn = document.getElementById('file-btn');
        const fileInput = document.getElementById('file-input');
        
        fileBtn.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                // Validate file size (8MB limit)
                if (file.size > 8 * 1024 * 1024) {
                    showError(`File ${file.name} is too large. Maximum size is 8MB.`);
                    return;
                }
                
                // Validate file extension
                const ext = file.name.split('.').pop().toLowerCase();
                const blockedExts = ['exe', 'msi', 'bat', 'cmd', 'com', 'pif', 'scr', 'vbs', 'js', 'jar', 'app', 'deb', 'dmg', 'pkg', 'rpm', 'sh', 'ps1', 'psm1', 'psd1', 'ps1xml', 'psc1', 'pssc', 'cdxml', 'xaml'];
                
                if (blockedExts.includes(ext)) {
                    showError(`File type .${ext} is not allowed.`);
                    return;
                }
                
                sendFileMessage(file);
            });
            
            // Reset input
            fileInput.value = '';
        });
        
        // Drag and drop functionality
        const messageInputEl = document.getElementById('message-input');
        const messageFormEl = document.getElementById('message-form');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            messageFormEl.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            messageFormEl.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            messageFormEl.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight(e) {
            messageFormEl.classList.add('drag-over');
        }
        
        function unhighlight(e) {
            messageFormEl.classList.remove('drag-over');
        }
        
        messageFormEl.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            Array.from(files).forEach(file => {
                // Validate file size (8MB limit)
                if (file.size > 8 * 1024 * 1024) {
                    showError(`File ${file.name} is too large. Maximum size is 8MB.`);
                    return;
                }
                
                // Validate file extension
                const ext = file.name.split('.').pop().toLowerCase();
                const blockedExts = ['exe', 'msi', 'bat', 'cmd', 'com', 'pif', 'scr', 'vbs', 'js', 'jar', 'app', 'deb', 'dmg', 'pkg', 'rpm', 'sh', 'ps1', 'psm1', 'psd1', 'ps1xml', 'psc1', 'pssc', 'cdxml', 'xaml'];
                
                if (blockedExts.includes(ext)) {
                    showError(`File type .${ext} is not allowed.`);
                    return;
                }
                
                sendFileMessage(file);
            });
        }


        // Users modal event listeners
        if (usersBtn) usersBtn.addEventListener('click', showUsersModal);
        if (usersModalClose) usersModalClose.addEventListener('click', hideUsersModal);

        clearRecipientBtn.addEventListener('click', () => { 
            currentRecipient = null; 
            clearRecipientBtn.classList.add('hidden'); 
            switchToGlobal();
        });

        statusSelect.addEventListener('change', () => {
            updateUserStatus(statusSelect.value);
        });

        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                if (document.hidden) { 
                    stopPolling();
                    // Set to away when tab becomes hidden
                    if (!currentUser.is_guest && currentUserStatus === 'online') {
                        updateUserStatus('away');
                    }
                }
                else {
                    markAsSeen();
                    // Reset to online when tab becomes visible again
                    if (!currentUser.is_guest && currentUserStatus === 'away') {
                        updateUserStatus('online');
                    }
                    resetAwayTimer();
                    
                    if (window.PinSystem && PinSystem.isUnlocked()) { 
                        loadMessages(); 
                        startPolling(); 
                    }
                    else if (window.PinSystem && !PinSystem.isUnlocked()) { 
                        PinSystem.showOverlayIfLocked(); 
                    }
                }
            }
        });

        window.addEventListener('focus', () => { 
            markAsSeen(); 
            if (currentUser && !currentUser.is_guest) {
                resetAwayTimer();
                if (currentUserStatus === 'away') {
                    updateUserStatus('online');
                }
            }
            if (window.PinSystem && PinSystem.isUnlocked()) loadMessages(); 
        });

        // Track user activity to reset away timer
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(event => {
            document.addEventListener(event, () => {
                if (currentUser && !currentUser.is_guest) {
                    resetAwayTimer();
                }
            }, { passive: true });
        });

        // GIF Browser functionality
        (function gifBrowserModule() {
            const gifBtn = document.getElementById('gif-btn');
            const gifBrowser = document.getElementById('gif-browser');
            const gifSearch = document.getElementById('gif-search');
            const gifGrid = document.getElementById('gif-grid');
            
            let searchTimeout = null;
            let isGifBrowserOpen = false;
            
            async function searchGifs(query) {
                if (!query.trim()) {
                    gifGrid.innerHTML = `
                        <div class="text-center text-gray-400 py-8 col-span-full">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p>Search for GIFs to send</p>
                        </div>
                    `;
                    return;
                }
                
                gifGrid.innerHTML = `
                    <div class="text-center text-gray-400 py-8 col-span-full">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Searching...</p>
                    </div>
                `;
                
                try {
                    const response = await fetch(`${API_BASE_URL}/gifs/search?q=${encodeURIComponent(query)}&limit=20`);
                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to search GIFs');
                    }
                    
                    if (data.gifs && data.gifs.length > 0) {
                        gifGrid.innerHTML = '';
                        data.gifs.forEach(gif => {
                            const gifItem = document.createElement('div');
                            gifItem.className = 'gif-item';
                            gifItem.innerHTML = `<img src="${gif.preview_url || gif.url}" alt="${gif.title}" loading="lazy">`;
                            gifItem.addEventListener('click', () => sendGif(gif.url));
                            gifGrid.appendChild(gifItem);
                        });
                    } else {
                        gifGrid.innerHTML = `
                            <div class="text-center text-gray-400 py-8 col-span-full">
                                <i class="fas fa-search text-2xl mb-2"></i>
                                <p>No GIFs found. Try a different search term.</p>
                            </div>
                        `;
                    }
                } catch (err) {
                    console.error('GIF search failed:', err);
                    gifGrid.innerHTML = `
                        <div class="text-center text-red-400 py-8 col-span-full">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Failed to search GIFs. Please try again.</p>
                        </div>
                    `;
                }
            }
            
            function toggleGifBrowser() {
                isGifBrowserOpen = !isGifBrowserOpen;
                if (isGifBrowserOpen) {
                    gifBrowser.classList.remove('hidden');
                    gifBtn.classList.add('active');
                    gifSearch.focus();
                } else {
                    gifBrowser.classList.add('hidden');
                    gifBtn.classList.remove('active');
                    gifSearch.value = '';
                    gifGrid.innerHTML = `
                        <div class="text-center text-gray-400 py-8 col-span-full">
                            <i class="fas fa-search text-2xl mb-2"></i>
                            <p>Search for GIFs to send</p>
                        </div>
                    `;
                }
            }
            
            async function sendGif(gifUrl) {
                if (!currentUser) return;
                
                setLoading(true);
                try {
                    const recipient_id = currentRecipient ? currentRecipient.id : null;
                    const group_id = currentGroup ? currentGroup.id : null;
                    const message = await sendMessage(gifUrl, recipient_id, group_id);
                    addMessage(message, true, true); // Animate GIF messages
                    toggleGifBrowser(); // Close the browser after sending
                } catch (err) {
                    console.error('Failed to send GIF:', err);
                    if (err.message && err.message.includes('blocked by content filter')) {
                        try {
                            const errorData = JSON.parse(err.message);
                            showModerationModal(errorData.reason);
                        } catch {
                            showModerationModal('Your GIF was blocked by our content filter.');
                        }
                    } else {
                        showError('Failed to send GIF');
                    }
                } finally {
                    setLoading(false);
                }
            }
            
            // Event listeners
            gifBtn.addEventListener('click', (e) => {
                e.preventDefault();
                toggleGifBrowser();
            });
            
            gifSearch.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchGifs(e.target.value);
                }, 500);
            });
            
            // Close GIF browser when clicking outside
            document.addEventListener('click', (e) => {
                if (isGifBrowserOpen && !gifBrowser.contains(e.target) && !gifBtn.contains(e.target)) {
                    toggleGifBrowser();
                }
            });
            
            // Prevent form submission when in GIF browser
            gifBrowser.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            gifSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    toggleGifBrowser();
                }
                e.stopPropagation();
            });
        })();

        (function notesAppModule() {
            const NOTES_KEY = 'notes_app_v1';
            const lockPanel = document.getElementById('lock-panel');

            function loadNotesFromStorage() {
                try {
                    const raw = localStorage.getItem(NOTES_KEY);
                    if (!raw) return [];
                    return JSON.parse(raw);
                } catch (e) {
                    console.error('Failed to parse notes:', e);
                    return [];
                }
            }
            function saveNotesToStorage(notes) {
                localStorage.setItem(NOTES_KEY, JSON.stringify(notes || []));
            }

            function createNoteObject() {
                return {
                    id: Date.now() + Math.floor(Math.random() * 999),
                    title: 'Untitled',
                    content: '',
                    updatedAt: new Date().toISOString()
                };
            }

            window.openNotesMode = function openNotesMode() {
                const notes = loadNotesFromStorage();

                if (!notes || notes.length === 0) {
                    const sample = createNoteObject();
                    sample.title = 'Weekly Assignments';
                    sample.content = 'DUE NEXT WEDNESDAY: ';
                    notes.push(sample);
                    saveNotesToStorage(notes);
                }

                lockPanel.innerHTML = `
                    <div class="notes-app w-full">
                        <div class="flex gap-4">
                            <div class="notes-sidebar w-1/3 border-r pr-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-lg font-semibold">Notes</h3>
                                    <div class="flex gap-2">
                                        <button id="notes-new" class="px-3 py-1 text-sm rounded bg-green-600 hover:bg-green-700">New</button>
                                        <button id="notes-close" class="px-3 py-1 text-sm rounded bg-gray-600 hover:bg-gray-700">Close</button>
                                    </div>
                                </div>
                                <input id="notes-search" placeholder="Search..." class="w-full mb-3 p-2 rounded bg-dark-700 border border-dark-500 text-sm" />
                                <div id="notes-list" style="max-height:420px;overflow:auto;"></div>
                            </div>
                            <div class="notes-editor flex-1 pl-4">
                                <div class="flex items-center justify-between mb-3">
                                    <input id="note-title" class="text-xl p-2 rounded bg-dark-800 border border-dark-500 w-3/4" placeholder="Title" />
                                    <div class="flex gap-2">
                                        <button id="note-delete" class="px-3 py-1 text-sm rounded bg-red-600 hover:bg-red-700">Delete</button>
                                        <button id="note-save" class="px-3 py-1 text-sm rounded bg-blue-600 hover:bg-blue-700">Save</button>
                                    </div>
                                </div>
                                <textarea id="note-content" class="w-full h-72 p-3 rounded bg-dark-700 border border-dark-500" placeholder="Write your note..."></textarea>
                                <div id="note-meta" class="text-xs text-gray-400 mt-2"></div>
                            </div>
                        </div>
                    </div>
                `;

                const notesListEl = document.getElementById('notes-list');
                const titleEl = document.getElementById('note-title');
                const contentEl = document.getElementById('note-content');
                const saveBtn = document.getElementById('note-save');
                const deleteBtn = document.getElementById('note-delete');
                const newBtn = document.getElementById('notes-new');
                const closeBtn = document.getElementById('notes-close');
                const searchEl = document.getElementById('notes-search');
                const metaEl = document.getElementById('note-meta');

                let notesState = loadNotesFromStorage();
                let currentNoteId = notesState[0] && notesState[0].id;

                function renderList(filter = '') {
                    const f = filter.trim().toLowerCase();
                    notesListEl.innerHTML = '';
                    const ordered = notesState.slice().sort((a,b) => b.updatedAt.localeCompare(a.updatedAt));
                    ordered.forEach(n => {
                        if (f && !(n.title + ' ' + n.content).toLowerCase().includes(f)) return;
                        const item = document.createElement('div');
                        item.className = 'note-item p-2 mb-2 rounded hover:bg-dark-800 cursor-pointer border border-dark-600';
                        item.dataset.id = n.id;
                        item.innerHTML = `<div class="flex justify-between items-start"><strong>${escapeHtml(n.title || 'Untitled')}</strong><span class="text-xs text-gray-400">${new Date(n.updatedAt).toLocaleString()}</span></div>
                                          <div class="text-sm text-gray-400 truncate mt-1">${escapeHtml(n.content || '')}</div>`;
                        item.addEventListener('click', () => {
                            loadNoteIntoEditor(n.id);
                        });
                        notesListEl.appendChild(item);
                    });
                    highlightSelected();
                }

                function loadNoteIntoEditor(id) {
                    const note = notesState.find(x => x.id === Number(id));
                    if (!note) return;
                    currentNoteId = note.id;
                    titleEl.value = note.title;
                    contentEl.value = note.content;
                    metaEl.textContent = `Last edited: ${new Date(note.updatedAt).toLocaleString()}`;
                    highlightSelected();
                }

                function highlightSelected() {
                    const items = Array.from(document.querySelectorAll('.note-item'));
                    items.forEach(el => el.classList.toggle('bg-dark-900', Number(el.dataset.id) === Number(currentNoteId)));
                }

                function persistState() {
                    saveNotesToStorage(notesState);
                    renderList(searchEl.value || '');
                }

                function saveCurrentNote() {
                    if (!currentNoteId) return;
                    const idx = notesState.findIndex(x => x.id === Number(currentNoteId));
                    if (idx === -1) return;
                    notesState[idx].title = titleEl.value || 'Untitled';
                    notesState[idx].content = contentEl.value || '';
                    notesState[idx].updatedAt = new Date().toISOString();
                    persistState();
                    metaEl.textContent = `Saved: ${new Date(notesState[idx].updatedAt).toLocaleString()}`;
                }

                function deleteCurrentNote() {
                    if (!currentNoteId) return;
                    if (!confirm('Delete this note?')) return;
                    notesState = notesState.filter(x => x.id !== Number(currentNoteId));
                    if (notesState.length === 0) {
                        const n = createNoteObject();
                        notesState.push(n);
                    }
                    currentNoteId = notesState[0].id;
                    persistState();
                    loadNoteIntoEditor(currentNoteId);
                }

                let autosaveTimer = null;
                function scheduleAutosave() {
                    clearTimeout(autosaveTimer);
                    autosaveTimer = setTimeout(() => {
                        if (currentNoteId) {
                            saveCurrentNote();
                        }
                    }, 700);
                }

                newBtn.addEventListener('click', () => {
                    const n = createNoteObject();
                    notesState.unshift(n);
                    currentNoteId = n.id;
                    persistState();
                    loadNoteIntoEditor(currentNoteId);
                    titleEl.focus();
                });

                saveBtn.addEventListener('click', () => {
                    saveCurrentNote();
                });

                deleteBtn.addEventListener('click', () => {
                    deleteCurrentNote();
                });

                closeBtn.addEventListener('click', () => {

                    window.location.reload();
                });

                titleEl.addEventListener('input', scheduleAutosave);
                contentEl.addEventListener('input', scheduleAutosave);
                searchEl.addEventListener('input', () => renderList(searchEl.value || ''));

                renderList();
                loadNoteIntoEditor(currentNoteId);
            };

            document.addEventListener('dummyPinMatched', (e) => {
                window.openNotesMode && window.openNotesMode();
            });
        })();

        moderationOk.addEventListener('click', hideModerationModal);
        
        // Ban modal event listeners
        banOk.addEventListener('click', () => {
            hideBanModal();
            // Reload page to clear any session data
            window.location.reload();
        });

        // Admin controls event listeners
        if (adminBtn) adminBtn.addEventListener('click', showAdminModal);
        if (adminModalClose) adminModalClose.addEventListener('click', hideAdminModal);

        if (banUserBtn) banUserBtn.addEventListener('click', async () => {
            const username = banUsernameInput.value.trim();
            const reason = banReasonInput.value.trim();
            
            if (!username) {
                adminMsg.textContent = 'Please enter a username';
                adminMsg.className = 'text-sm text-center text-red-400';
                return;
            }
            
            try {
                await banUser(username, reason);
                adminMsg.textContent = `User ${username} has been banned`;
                adminMsg.className = 'text-sm text-center text-green-400';
                banUsernameInput.value = '';
                banReasonInput.value = '';
            } catch (err) {
                adminMsg.textContent = err.message || 'Failed to ban user';
                adminMsg.className = 'text-sm text-center text-red-400';
            }
        });

        if (unbanUserBtn) unbanUserBtn.addEventListener('click', async () => {
            const username = unbanUsernameInput.value.trim();
            
            if (!username) {
                adminMsg.textContent = 'Please enter a username';
                adminMsg.className = 'text-sm text-center text-red-400';
                return;
            }
            
            try {
                await unbanUser(username);
                adminMsg.textContent = `User ${username} has been unbanned`;
                adminMsg.className = 'text-sm text-center text-green-400';
                unbanUsernameInput.value = '';
            } catch (err) {
                adminMsg.textContent = err.message || 'Failed to unban user';
                adminMsg.className = 'text-sm text-center text-red-400';
            }
        });

        // Profile picture event listeners
        if (profilePicBtn) profilePicBtn.addEventListener('click', showProfilePicModal);
        if (profilePicModalClose) profilePicModalClose.addEventListener('click', hideProfilePicModal);
        if (removeProfilePicBtn) removeProfilePicBtn.addEventListener('click', removeProfilePicture);

        // Chat navigation event listeners
        const globalChatBtn = document.getElementById('global-chat-btn');
        const dmsBtn = document.getElementById('dms-btn');
        const groupsBtn = document.getElementById('groups-btn');
        
        if (globalChatBtn) globalChatBtn.addEventListener('click', switchToGlobal);
        if (dmsBtn) dmsBtn.addEventListener('click', toggleDMsDropdown);
        if (groupsBtn) groupsBtn.addEventListener('click', toggleGroupsDropdown);
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            const dmsDropdown = document.getElementById('dms-dropdown');
            const dmsBtn = document.getElementById('dms-btn');
            const groupsDropdown = document.getElementById('groups-dropdown');
            const groupsBtn = document.getElementById('groups-btn');
            
            if (!dmsDropdown.contains(e.target) && !dmsBtn.contains(e.target)) {
                dmsDropdown.classList.add('hidden');
            }
            
            if (!groupsDropdown.contains(e.target) && !groupsBtn.contains(e.target)) {
                groupsDropdown.classList.add('hidden');
            }
        });

        // Group chat event listeners
        const createGroupBtn = document.getElementById('create-group-btn');
        const createGroupModalClose = document.getElementById('create-group-modal-close');
        const createGroupSubmitBtn = document.getElementById('create-group-submit-btn');
        
        // Group management event listeners
        const groupManagementModalClose = document.getElementById('group-management-modal-close');
        const groupRenameBtn = document.getElementById('group-rename-btn');
        const groupAddMemberBtn = document.getElementById('group-add-member-btn');
        const groupDeleteBtn = document.getElementById('group-delete-btn');
        const cancelGroupBtn = document.getElementById('cancel-group-btn');
        
        if (createGroupBtn) createGroupBtn.addEventListener('click', showCreateGroupModal);
        if (createGroupModalClose) createGroupModalClose.addEventListener('click', hideCreateGroupModal);
        if (cancelGroupBtn) cancelGroupBtn.addEventListener('click', hideCreateGroupModal);
        
        // Group management event listeners
        if (groupManagementModalClose) groupManagementModalClose.addEventListener('click', hideGroupManagementModal);
        if (groupRenameBtn) groupRenameBtn.addEventListener('click', () => {
            const group = currentGroup;
            if (group) updateGroupName(group.id);
        });
        if (groupAddMemberBtn) groupAddMemberBtn.addEventListener('click', () => {
            const group = currentGroup;
            if (group) addMemberToGroup(group.id);
        });
        if (groupDeleteBtn) groupDeleteBtn.addEventListener('click', () => {
            const group = currentGroup;
            if (group) deleteGroup(group.id);
        });
        
        if (createGroupSubmitBtn) {
            createGroupSubmitBtn.addEventListener('click', async () => {
                const name = document.getElementById('create-group-name-input').value.trim();
                const msgEl = document.getElementById('create-group-msg');
                
                if (!name) {
                    msgEl.textContent = 'Please enter a group name';
                    msgEl.className = 'text-sm text-center text-red-400';
                    return;
                }
                
                // Get selected members
                const checkboxes = document.querySelectorAll('#group-members-list input[type="checkbox"]:checked');
                const memberIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
                
                try {
                    const group = await createGroupChat(name, memberIds);
                    msgEl.textContent = 'Group created successfully!';
                    msgEl.className = 'text-sm text-center text-green-400';
                    
                    // Reload user groups
                    await loadUserGroups();
                    
                    setTimeout(() => {
                        hideCreateGroupModal();
                    }, 1500);
                } catch (err) {
                    msgEl.textContent = err.message || 'Failed to create group';
                    msgEl.className = 'text-sm text-center text-red-400';
                }
            });
        }

        if (profilePicSearch) {
            let searchTimeout = null;
            profilePicSearch.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchProfilePicGifs(e.target.value);
                }, 500);
            });
        }

        function checkCookieBan() {
            // Check if user has a banned cookie
            const bannedCookie = document.cookie
                .split('; ')
                .find(row => row.startsWith('banned_user='));
            
            if (bannedCookie) {
                showBanModal('You have been banned from this site.');
                return true;
            }
            return false;
        }

        function preventBannedActions() {
            // Check for cookie ban before any auth action
            if (checkCookieBan()) {
                return true; // Prevent action
            }
            return false; // Allow action
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            updateCharCount();
            setFavicon(DEFAULT_FAVICON);
            document.title = 'Online Notepad';
            
            // Check for cookie ban on page load
            if (checkCookieBan()) {
                // Hide auth screen and show ban modal
                authScreen.classList.add('hidden');
            }
        });
    </script>

    <!-- Load lock.js after DOM is ready -->
    <script src="lock.js"></script>
    <script>
        // Initialize lock system after everything is loaded
        if (window.PinSystem && window.PinSystem.init) {
            window.PinSystem.init();
        }
    </script>
</body>
</html>
